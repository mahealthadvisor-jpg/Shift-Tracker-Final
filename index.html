<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Shift Tracker - Cloud</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700&family=Roboto+Mono:wght@400;600&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --ice-white: #F8FBFF;
            --ice-blue: #E8F4FF;
            --rink-dark: #1a2332;
            --rink-darker: #0f1621;
            --line-blue: #0066CC;
            --active-green: #00E676;
            --warn-amber: #FFB300;
            --pp-gold: #FFC107;
            --pk-red: #FF5252;
            --bench-gray: #64748b;
            --text-light: #e2e8f0;
            --shadow-ice: rgba(0, 102, 204, 0.15);
        }
        
        body {
            font-family: 'Roboto Mono', monospace;
            background: linear-gradient(135deg, var(--rink-darker) 0%, var(--rink-dark) 100%);
            color: var(--text-light);
            min-height: 100vh;
            margin: 0;
        }
        
        /* SCREEN MANAGEMENT */
        .screen {
            display: none;
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
            min-height: 100vh;
        }
        
        .screen.active {
            display: block;
        }
        
        /* AUTH SCREEN STYLES */
        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .auth-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 40px;
            border-radius: 16px;
            border: 2px solid var(--line-blue);
            max-width: 400px;
            width: 100%;
            backdrop-filter: blur(10px);
        }
        
        .auth-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--ice-white) 0%, var(--line-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .auth-subtitle {
            text-align: center;
            color: var(--bench-gray);
            margin-bottom: 30px;
            font-size: 0.9rem;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--bench-gray);
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--bench-gray);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 1rem;
            font-family: 'Roboto Mono', monospace;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--line-blue);
            background: rgba(255, 255, 255, 0.12);
        }
        
        .btn-auth {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            background: var(--line-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-auth:hover {
            background: #0052a3;
            transform: translateY(-2px);
        }
        
        .btn-auth:active {
            transform: translateY(0);
        }
        
        .btn-auth.secondary {
            background: transparent;
            border: 2px solid var(--line-blue);
        }
        
        .btn-auth.secondary:hover {
            background: rgba(0, 102, 204, 0.1);
        }
        
        .auth-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: none;
        }
        
        .auth-message.error {
            background: rgba(255, 82, 82, 0.2);
            border: 1px solid var(--pk-red);
            color: var(--pk-red);
            display: block;
        }
        
        .auth-message.success {
            background: rgba(0, 230, 118, 0.2);
            border: 1px solid var(--active-green);
            color: var(--active-green);
            display: block;
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--bench-gray);
        }
        
        .auth-toggle button {
            background: none;
            border: none;
            color: var(--line-blue);
            cursor: pointer;
            text-decoration: underline;
            font-family: inherit;
        }
        
        /* LOADING INDICATOR */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--line-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* HOME DASHBOARD */
        .nav-bar {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-email {
            color: var(--bench-gray);
            font-size: 0.85rem;
        }
        
        .btn-nav {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--bench-gray);
            color: var(--text-light);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: 'Roboto Mono', monospace;
            transition: all 0.3s ease;
        }
        
        .btn-nav:hover {
            background: var(--line-blue);
            border-color: var(--line-blue);
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--bench-gray);
        }
        
        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--active-green);
        }
        
        .sync-dot.syncing {
            background: var(--warn-amber);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .dashboard-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 12px;
            border: 2px solid rgba(0, 102, 204, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .dashboard-card:hover {
            border-color: var(--line-blue);
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-4px);
        }
        
        .card-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .card-description {
            font-size: 0.9rem;
            color: var(--bench-gray);
        }
        
        /* GAME LIBRARY */
        .game-list {
            display: grid;
            gap: 15px;
        }
        
        .game-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid rgba(0, 102, 204, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .game-item:hover {
            border-color: var(--line-blue);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .game-info {
            flex: 1;
        }
        
        .game-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .game-meta {
            font-size: 0.85rem;
            color: var(--bench-gray);
        }
        
        .game-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 8px 16px;
            background: var(--line-blue);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-family: 'Roboto Mono', monospace;
            transition: all 0.3s ease;
        }
        
        .btn-small:hover {
            background: #0052a3;
        }
        
        .btn-small.danger {
            background: var(--pk-red);
        }
        
        .btn-small.danger:hover {
            background: #cc0000;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--bench-gray);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        /* ALL ORIGINAL TRACKER STYLES */
        /* (Keeping all existing game tracker styles) */
        @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700&family=Roboto+Mono:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --ice-white: #F8FBFF;
            --ice-blue: #E8F4FF;
            --rink-dark: #1a2332;
            --rink-darker: #0f1621;
            --line-blue: #0066CC;
            --active-green: #00E676;
            --warn-amber: #FFB300;
            --pp-gold: #FFC107;
            --pk-red: #FF5252;
            --bench-gray: #64748b;
            --text-light: #e2e8f0;
            --shadow-ice: rgba(0, 102, 204, 0.15);
        }
        
        body {
            font-family: 'Roboto Mono', monospace;
            background: linear-gradient(135deg, var(--rink-darker) 0%, var(--rink-dark) 100%);
            color: var(--text-light);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--line-blue);
            position: relative;
        }
        
        .score-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
            font-family: 'Barlow Condensed', sans-serif;
        }
        
        .team-score {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .team-name {
            font-size: 0.9rem;
            color: var(--bench-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .score-number {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .score-number.us {
            color: var(--active-green);
        }
        
        .score-number.them {
            color: var(--pk-red);
        }
        
        .score-divider {
            font-size: 2.5rem;
            color: var(--bench-gray);
            font-weight: 300;
        }
        
        h1 {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--ice-white) 0%, var(--line-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 0.85rem;
            color: var(--bench-gray);
            letter-spacing: 1px;
        }
        
        .control-bar {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(0, 102, 204, 0.2);
        }
        
        .period-strength-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .period-selector, .strength-selector, .zone-selector {
            display: flex;
            gap: 6px;
        }
        
        .period-btn, .strength-btn, .zone-btn {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--bench-gray);
            color: var(--text-light);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .period-btn:hover, .strength-btn:hover, .zone-btn:hover {
            background: rgba(0, 102, 204, 0.2);
            border-color: var(--line-blue);
        }
        
        .period-btn.active {
            background: var(--line-blue);
            border-color: var(--line-blue);
            color: white;
        }
        
        .strength-btn.active.es {
            background: var(--active-green);
            border-color: var(--active-green);
            color: var(--rink-darker);
        }
        
        .strength-btn.active.pp {
            background: var(--pp-gold);
            border-color: var(--pp-gold);
            color: var(--rink-darker);
        }
        
        .strength-btn.active.pk {
            background: var(--pk-red);
            border-color: var(--pk-red);
            color: white;
        }
        
        .zone-btn.active {
            background: var(--line-blue);
            border-color: var(--line-blue);
            color: white;
        }
        
        .game-clock {
            font-family: 'Roboto Mono', monospace;
            font-size: 2.2rem;
            font-weight: 600;
            color: var(--ice-white);
            text-align: center;
        }
        
        .clock-controls {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            justify-content: center;
        }
        
        .clock-btn {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.7rem;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--bench-gray);
            color: var(--text-light);
            cursor: pointer;
            border-radius: 4px;
        }
        
        .clock-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .action-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-export {
            background: var(--active-green);
            color: var(--rink-darker);
        }
        
        .btn-export:hover {
            background: #00ff88;
        }
        
        .btn-pdf {
            background: var(--pk-red);
            color: white;
        }
        
        .btn-pdf:hover {
            background: #ff3333;
        }
        
        .btn-config {
            background: var(--line-blue);
            color: white;
        }
        
        .btn-config:hover {
            background: #0052a3;
        }
        
        .btn-clear {
            background: rgba(255, 179, 0, 0.2);
            color: var(--warn-amber);
            border: 2px solid var(--warn-amber);
        }
        
        .btn-clear:hover {
            background: var(--warn-amber);
            color: var(--rink-darker);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
        }
        
        .lines-section {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        
        .line-group {
            background: rgba(255, 255, 255, 0.03);
            padding: 18px;
            border-radius: 10px;
            border: 1px solid rgba(0, 102, 204, 0.2);
        }
        
        .line-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .line-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--line-blue);
        }
        
        .line-toggle {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--bench-gray);
            color: var(--text-light);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .line-toggle:hover {
            background: rgba(0, 102, 204, 0.2);
            border-color: var(--line-blue);
        }
        
        .line-toggle.active {
            background: var(--active-green);
            border-color: var(--active-green);
            color: var(--rink-darker);
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.3);
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 10px;
        }
        
        .player-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 6px;
            border: 2px solid rgba(100, 116, 139, 0.3);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .player-card:hover {
            background: rgba(0, 102, 204, 0.15);
            border-color: var(--line-blue);
            transform: translateY(-2px);
        }
        
        .player-card.on-ice {
            border-color: var(--active-green);
            background: rgba(0, 230, 118, 0.1);
        }
        
        .player-card.on-ice:hover {
            background: rgba(0, 230, 118, 0.15);
        }
        
        .player-number {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .player-name {
            font-size: 0.75rem;
            color: var(--line-blue);
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 0 8px rgba(0, 102, 204, 0.4);
        }
        
        .player-toi {
            font-size: 0.8rem;
            color: var(--text-light);
            font-weight: 600;
        }
        
        .player-toi.active {
            color: var(--active-green);
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        
        .stats-panel {
            background: rgba(255, 255, 255, 0.03);
            padding: 18px;
            border-radius: 10px;
            border: 1px solid rgba(0, 102, 204, 0.2);
        }
        
        .panel-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--line-blue);
            margin-bottom: 12px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(100, 116, 139, 0.2);
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--bench-gray);
        }
        
        .stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--ice-white);
        }
        
        .stat-value.warning {
            color: var(--warn-amber);
        }
        
        .event-logger {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .event-btn {
            flex: 1;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 10px;
            border: 2px solid var(--bench-gray);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-light);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .event-btn:hover {
            background: rgba(0, 102, 204, 0.2);
            border-color: var(--line-blue);
        }
        
        .event-btn.goal {
            border-color: var(--active-green);
        }
        
        .event-btn.goal:hover {
            background: var(--active-green);
            color: var(--rink-darker);
        }
        
        .event-btn.opp {
            border-color: var(--pk-red);
        }
        
        .event-btn.opp:hover {
            background: rgba(255, 82, 82, 0.2);
            border-color: var(--pk-red);
        }
        
        .event-btn.goal.opp:hover {
            background: var(--pk-red);
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--rink-dark);
            padding: 30px;
            border-radius: 12px;
            border: 2px solid var(--line-blue);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--line-blue);
            margin-bottom: 20px;
        }
        
        .editor-section {
            margin-bottom: 25px;
        }
        
        .editor-section-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .player-editor {
            display: grid;
            grid-template-columns: 80px 1fr 80px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        input[type="number"], input[type="text"], textarea {
            font-family: 'Roboto Mono', monospace;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--bench-gray);
            color: var(--text-light);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--line-blue);
            background: rgba(255, 255, 255, 0.08);
        }
        
        textarea {
            width: 100%;
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-modal {
            flex: 1;
        }
        
        .events-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 6px;
            background: rgba(0, 230, 118, 0.1);
            border-left: 3px solid var(--active-green);
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .event-item.shot {
            background: rgba(0, 102, 204, 0.1);
            border-left-color: var(--line-blue);
        }
        
        .event-item.opponent {
            background: rgba(255, 82, 82, 0.1);
            border-left-color: var(--pk-red);
        }
        
        .event-item.opponent.goal {
            background: rgba(255, 82, 82, 0.15);
        }
        
        .clock-editor {
            display: none;
            position: absolute;
            background: var(--rink-dark);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--line-blue);
            z-index: 100;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .clock-editor.active {
            display: block;
        }
        
        .clock-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .clock-input input {
            width: 60px;
            text-align: center;
            font-size: 1.2rem;
        }
        
        .clock-input span {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .player-status {
            font-size: 0.65rem;
            color: var(--active-green);
            font-weight: 600;
            margin-top: 4px;
        }
        
        /* Mobile Responsive Styles */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .subtitle {
                font-size: 0.75rem;
            }
            
            .score-display {
                gap: 15px;
            }
            
            .team-name {
                font-size: 0.75rem;
            }
            
            .score-number {
                font-size: 2.5rem;
            }
            
            .control-bar {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 15px;
            }
            
            .period-strength-group {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            
            .period-selector, .strength-selector, .zone-selector {
                width: 100%;
                justify-content: space-between;
            }
            
            .period-btn, .strength-btn, .zone-btn {
                flex: 1;
                font-size: 0.85rem;
                padding: 10px 8px;
            }
            
            .game-clock {
                font-size: 2rem;
            }
            
            .clock-controls {
                gap: 8px;
            }
            
            .action-btns {
                width: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .btn {
                font-size: 0.75rem;
                padding: 10px 8px;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .lines-section {
                order: 2;
            }
            
            .sidebar {
                order: 1;
            }
            
            .line-group {
                padding: 15px;
            }
            
            .line-title {
                font-size: 1rem;
            }
            
            .line-toggle {
                font-size: 0.9rem;
                padding: 10px 16px;
            }
            
            .players-grid {
                grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
                gap: 8px;
            }
            
            .player-card {
                padding: 10px;
            }
            
            .player-number {
                font-size: 1.4rem;
            }
            
            .player-name {
                font-size: 0.65rem;
            }
            
            .player-toi {
                font-size: 0.75rem;
            }
            
            .stats-panel {
                padding: 15px;
            }
            
            .panel-title {
                font-size: 1rem;
            }
            
            .stat-row {
                padding: 6px 0;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
            
            .stat-value {
                font-size: 0.9rem;
            }
            
            .event-btn {
                font-size: 0.8rem;
                padding: 12px 8px;
            }
            
            .event-item {
                font-size: 0.8rem;
                padding: 6px;
            }
            
            .modal-content {
                padding: 20px;
                max-width: 95%;
            }
            
            .modal-header {
                font-size: 1.4rem;
            }
            
            .editor-section-title {
                font-size: 0.95rem;
            }
            
            input[type="number"], input[type="text"], textarea {
                font-size: 16px; /* Prevents iOS zoom on focus */
            }
            
            .clock-editor {
                max-width: 90%;
                padding: 15px;
            }
        }
        
        /* Extra small devices (iPhone SE, etc) */
        @media screen and (max-width: 375px) {
            h1 {
                font-size: 1.5rem;
            }
            
            .score-number {
                font-size: 2rem;
            }
            
            .game-clock {
                font-size: 1.8rem;
            }
            
            .players-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-btns {
                grid-template-columns: 1fr;
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .player-card, .line-toggle, .btn, .period-btn, .strength-btn, .zone-btn, .event-btn {
                min-height: 44px; /* iOS minimum touch target */
            }
            
            .player-card:active {
                transform: scale(0.95);
            }
            
            .line-toggle:active, .btn:active {
                transform: scale(0.98);
            }
        }
    </style>
</head>
<body>

<!-- ========== LOGIN/SIGNUP SCREEN ========== -->
<div id="authScreen" class="screen auth-screen active">
    <div class="auth-container">
        <div class="auth-title">SHIFT TRACKER</div>
        <div class="auth-subtitle">Cloud-Enabled Game Tracking</div>
        
        <div id="authMessage" class="auth-message"></div>
        
        <div id="loginForm">
            <div class="input-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="coach@example.com" autocomplete="email">
            </div>
            
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            </div>
            
            <button class="btn-auth" onclick="handleLogin()">Login</button>
            
            <div class="auth-toggle">
                Don't have an account? <button onclick="showSignup()">Sign Up</button>
            </div>
        </div>
        
        <div id="signupForm" style="display: none;">
            <div class="input-group">
                <label>Email</label>
                <input type="email" id="signupEmail" placeholder="coach@example.com" autocomplete="email">
            </div>
            
            <div class="input-group">
                <label>Password (min 6 characters)</label>
                <input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
            </div>
            
            <button class="btn-auth" onclick="handleSignup()">Sign Up</button>
            
            <div class="auth-toggle">
                Already have an account? <button onclick="showLogin()">Login</button>
            </div>
        </div>
    </div>
</div>

<!-- ========== HOME DASHBOARD ========== -->
<div id="homeScreen" class="screen">
    <div class="nav-bar">
        <div class="nav-left">
            <div class="dashboard-title" style="font-size: 1.5rem; margin: 0;">SHIFT TRACKER</div>
        </div>
        <div class="nav-right">
            <div class="sync-status">
                <div class="sync-dot" id="syncDot"></div>
                <span id="syncStatus">Ready</span>
            </div>
            <span class="user-email" id="userEmailDisplay"></span>
            <button class="btn-nav" onclick="handleLogout()">Logout</button>
        </div>
    </div>
    
    <div class="dashboard-grid">
        <div class="dashboard-card" onclick="startNewGame()">
            <div class="card-icon">üèí</div>
            <div class="card-title">New Game</div>
            <div class="card-description">Start tracking a new game</div>
        </div>
        
        <div class="dashboard-card" onclick="showGameLibrary()">
            <div class="card-icon">üìö</div>
            <div class="card-title">Game Library</div>
            <div class="card-description">View and load past games</div>
        </div>
        
        <div class="dashboard-card" onclick="alert('Season stats coming soon!')">
            <div class="card-icon">üìä</div>
            <div class="card-title">Season Stats</div>
            <div class="card-description">Coming soon!</div>
        </div>
        
        <div class="dashboard-card" onclick="alert('Team settings coming soon!')">
            <div class="card-icon">‚öôÔ∏è</div>
            <div class="card-title">Settings</div>
            <div class="card-description">Coming soon!</div>
        </div>
    </div>
</div>

<!-- ========== GAME LIBRARY SCREEN ========== -->
<div id="libraryScreen" class="screen">
    <div class="nav-bar">
        <button class="btn-nav" onclick="showScreen('homeScreen')">‚Üê Back to Home</button>
        <div class="dashboard-title" style="font-size: 1.5rem; margin: 0;">Game Library</div>
    </div>
    
    <div id="gameLibraryLoading" class="loading">
        <div class="spinner"></div>
        <div>Loading games...</div>
    </div>
    
    <div id="gameLibraryContent" style="display: none;">
        <div id="gameList" class="game-list"></div>
        <div id="emptyLibrary" class="empty-state" style="display: none;">
            <div class="empty-icon">üèí</div>
            <h2>No Games Yet</h2>
            <p>Start tracking your first game to see it here!</p>
            <button class="btn-auth" style="max-width: 200px; margin: 20px auto 0;" onclick="startNewGame()">Track New Game</button>
        </div>
    </div>
</div>

<!-- ========== GAME TRACKER SCREEN ========== -->
<div id="trackerScreen" class="screen">
    <div class="nav-bar">
        <button class="btn-nav" onclick="confirmLeaveGame()">‚Üê Back</button>
        <div class="sync-status">
            <div class="sync-dot" id="trackerSyncDot"></div>
            <span id="trackerSyncStatus">Ready</span>
        </div>
        <button class="btn-nav" onclick="saveGameNow()">üíæ Save Now</button>
    </div>
    <div class="container">
        <header>
            <h1>Shift Tracker Complete</h1>
            <div class="subtitle">Professional Ice Time & Event Tracking System</div>
            <div class="score-display">
                <div class="team-score">
                    <div class="team-name">Newburyport</div>
                    <div class="score-number us" id="scoreUs">0</div>
                </div>
                <div class="score-divider">-</div>
                <div class="team-score">
                    <div class="team-name">Opponent</div>
                    <div class="score-number them" id="scoreThem">0</div>
                </div>
            </div>
        </header>
        
        <div class="control-bar">
            <div class="period-strength-group">
                <div class="period-selector">
                    <button class="period-btn active" onclick="setPeriod(1)">P1</button>
                    <button class="period-btn" onclick="setPeriod(2)">P2</button>
                    <button class="period-btn" onclick="setPeriod(3)">P3</button>
                    <button class="period-btn" onclick="setPeriod(4)">OT</button>
                </div>
                <div class="strength-selector">
                    <button class="strength-btn active es" onclick="setStrength('5v5')">5v5</button>
                    <button class="strength-btn pp" onclick="setStrength('PP')">PP</button>
                    <button class="strength-btn pk" onclick="setStrength('PK')">PK</button>
                </div>
                <button class="btn btn-config" onclick="openFaceoffModal()" style="white-space: nowrap;">‚ö´ Faceoff</button>
            </div>
            
            <div>
                <div class="game-clock" id="gameClock" oncontextmenu="openClockEditor(event); return false;" title="Right-click to edit time">20:00</div>
                <div class="clock-controls">
                    <button class="clock-btn" onclick="startClock()">‚ñ∂</button>
                    <button class="clock-btn" onclick="pauseClock()">‚è∏</button>
                    <button class="clock-btn" onclick="resetClock()">‚Üª</button>
                </div>
                <div id="clockEditor" class="clock-editor">
                    <div style="font-size: 0.9rem; margin-bottom: 10px; color: var(--bench-gray);">Set Game Clock</div>
                    <div class="clock-input">
                        <input type="number" id="clockMinutes" min="0" max="20" value="20">
                        <span>:</span>
                        <input type="number" id="clockSeconds" min="0" max="59" value="0">
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-config" style="flex: 1;" onclick="setClockManual()">Set</button>
                        <button class="btn btn-clear" style="flex: 1;" onclick="closeClockEditor()">Cancel</button>
                    </div>
                </div>
            </div>
            
            <div class="action-btns">
                <button class="btn btn-export" onclick="exportCSV()">CSV</button>
                <button class="btn btn-pdf" onclick="exportPDF()">PDF</button>
                <button class="btn btn-config" onclick="openLineEditor()">Edit Lines</button>
                <button class="btn btn-config" onclick="openConfigModal()">Config</button>
                <button class="btn btn-clear" onclick="clearData()">Clear</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="lines-section" id="linesSection"></div>
            
            <div class="sidebar">
                <div class="stats-panel">
                    <div class="panel-title">Quick Events</div>
                    <div style="font-size: 0.75rem; color: var(--bench-gray); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Newburyport</div>
                    <div class="event-logger">
                        <button class="event-btn goal" onclick="logGoal('us')">‚ö´ GOAL</button>
                        <button class="event-btn" onclick="logShot('us')">üèí SHOT</button>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--bench-gray); margin: 12px 0 8px 0; text-transform: uppercase; letter-spacing: 1px;">Opponent</div>
                    <div class="event-logger">
                        <button class="event-btn goal opp" onclick="logGoal('them')">‚ö´ GOAL</button>
                        <button class="event-btn opp" onclick="logShot('them')">üèí SHOT</button>
                    </div>
                    <div class="events-list" id="eventsList"></div>
                </div>
                
                <div class="stats-panel">
                    <div class="panel-title">Game Stats</div>
                    <div class="stat-row">
                        <span class="stat-label">Total Shifts</span>
                        <span class="stat-value" id="totalShifts">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Avg Shift</span>
                        <span class="stat-value" id="avgShift">0:00</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Long Shifts (>60s)</span>
                        <span class="stat-value warning" id="longShifts">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">NBC Goals</span>
                        <span class="stat-value" id="ourGoals" style="color: var(--active-green);">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">OPP Goals</span>
                        <span class="stat-value" id="theirGoals" style="color: var(--pk-red);">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">NBC Shots</span>
                        <span class="stat-value" id="ourShots">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">OPP Shots</span>
                        <span class="stat-value" id="theirShots">0</span>
                    </div>
                </div>
                
                <div class="stats-panel">
                    <div class="panel-title">Faceoffs</div>
                    <div class="stat-row">
                        <span class="stat-label">Total FO</span>
                        <span class="stat-value" id="totalFaceoffs">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">FO Win %</span>
                        <span class="stat-value" id="faceoffPct">0%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Offensive Zone</span>
                        <span class="stat-value" id="oZoneFO">0-0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Neutral Zone</span>
                        <span class="stat-value" id="nZoneFO">0-0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Defensive Zone</span>
                        <span class="stat-value" id="dZoneFO">0-0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Clean Wins</span>
                        <span class="stat-value" id="cleanWins">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Line Editor Modal -->
    <div id="lineEditorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Line Editor</div>
            <div id="lineEditorContent"></div>
            <div class="modal-actions">
                <button class="btn btn-config btn-modal" onclick="saveLineConfig()">Save Configuration</button>
                <button class="btn btn-config btn-modal" onclick="loadLineConfig()">Load Configuration</button>
                <button class="btn btn-clear btn-modal" onclick="closeModal('lineEditorModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Config Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Configuration</div>
            
            <div class="editor-section">
                <div class="editor-section-title">Video Timestamps (Import)</div>
                <textarea id="videoTimestamps" placeholder="Paste video timestamps here (format: MM:SS or HH:MM:SS per line)"></textarea>
                <button class="btn btn-config" style="margin-top: 10px;" onclick="importVideoTimestamps()">Import Timestamps</button>
            </div>
            
            <div class="editor-section">
                <div class="editor-section-title">Game Info</div>
                <input type="text" id="gameDate" placeholder="Game Date" style="width: 100%; margin-bottom: 10px;">
                <input type="text" id="opponent" placeholder="Opponent" style="width: 100%; margin-bottom: 10px;">
                <input type="text" id="location" placeholder="Location" style="width: 100%;">
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-config btn-modal" onclick="saveGameInfo()">Save Game Info</button>
                <button class="btn btn-clear btn-modal" onclick="closeModal('configModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Faceoff Modal -->
    <div id="faceoffModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">Log Faceoff</div>
            
            <div class="editor-section">
                <div class="editor-section-title">Zone</div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="zone-btn" style="flex: 1;" onclick="setFaceoffZone('O')">Offensive</button>
                    <button class="zone-btn" style="flex: 1;" onclick="setFaceoffZone('N')">Neutral</button>
                    <button class="zone-btn" style="flex: 1;" onclick="setFaceoffZone('D')">Defensive</button>
                </div>
            </div>
            
            <div class="editor-section">
                <div class="editor-section-title">Player Taking Faceoff</div>
                <input type="number" id="faceoffPlayer" placeholder="Jersey #" style="width: 100%; margin-bottom: 15px;">
            </div>
            
            <div class="editor-section">
                <div class="editor-section-title">Result</div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="strength-btn es" style="flex: 1;" onclick="setFaceoffResult('W')">Win</button>
                    <button class="strength-btn pk" style="flex: 1;" onclick="setFaceoffResult('L')">Loss</button>
                </div>
            </div>
            
            <div class="editor-section">
                <div class="editor-section-title">Win Type (if won)</div>
                <div style="display: flex; gap: 10px;">
                    <button class="zone-btn" style="flex: 1;" onclick="setFaceoffClean(true)">Clean</button>
                    <button class="zone-btn" style="flex: 1;" onclick="setFaceoffClean(false)">Help</button>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-config btn-modal" onclick="saveFaceoff()">Save Faceoff</button>
                <button class="btn btn-clear btn-modal" onclick="closeModal('faceoffModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        let gameData = {
            gameInfo: {
                date: '',
                opponent: '',
                location: ''
            },
            currentPeriod: 1,
            currentStrength: '5v5',
            gameClock: 1200,
            clockRunning: false,
            clockInterval: null,
            videoTimestamps: [],
            lines: [
                { name: 'Line 1', type: 'forward', players: [
                    { number: 5, name: 'Mongeau', position: 'F', onIce: false, shiftStart: null },
                    { number: 7, name: 'Pons', position: 'F', onIce: false, shiftStart: null },
                    { number: 8, name: 'Arel', position: 'F', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'Line 2', type: 'forward', players: [
                    { number: 9, name: 'Sullivan', position: 'F', onIce: false, shiftStart: null },
                    { number: 18, name: 'Curran', position: 'F', onIce: false, shiftStart: null },
                    { number: 23, name: 'Barbera', position: 'F', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'Line 3', type: 'forward', players: [
                    { number: 6, name: 'MacIsaac', position: 'F', onIce: false, shiftStart: null },
                    { number: 15, name: 'Gagnon', position: 'F', onIce: false, shiftStart: null },
                    { number: 24, name: 'Waddell', position: 'F', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'Line 4', type: 'forward', players: [
                    { number: 11, name: 'Bavaro', position: 'F', onIce: false, shiftStart: null },
                    { number: 21, name: 'Donovan', position: 'F', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'D-Pair 1', type: 'defense', players: [
                    { number: 2, name: 'Becker', position: 'D', onIce: false, shiftStart: null },
                    { number: 20, name: 'Gudaitis', position: 'D', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'D-Pair 2', type: 'defense', players: [
                    { number: 10, name: 'Bergeron', position: 'D', onIce: false, shiftStart: null },
                    { number: 12, name: 'Thorne', position: 'D', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'D-Pair 3', type: 'defense', players: [
                    { number: 16, name: 'Varay', position: 'D', onIce: false, shiftStart: null },
                    { number: 17, name: 'Tramontana', position: 'D', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'Extra D', type: 'defense', players: [
                    { number: 19, name: 'DesRosiers', position: 'D', onIce: false, shiftStart: null },
                    { number: 27, name: 'Puleo', position: 'D', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null }
            ],
            shifts: [],
            events: [],
            faceoffs: [],
            faceoffTemp: {
                zone: null,
                player: null,
                result: null,
                clean: null
            }
        };
        
        // Load saved config on startup
        const savedConfig = localStorage.getItem('hockeyTrackerConfig');
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            if (config.lines) {
                gameData.lines = config.lines.map(line => ({
                    ...line,
                    onIce: false,
                    shiftStart: null,
                    players: line.players.map(player => ({
                        ...player,
                        onIce: false,
                        shiftStart: null
                    }))
                }));
            }
            gameData.gameInfo = config.gameInfo || gameData.gameInfo;
        }
        
        function renderLines() {
            const section = document.getElementById('linesSection');
            section.innerHTML = '';
            
            gameData.lines.forEach((line, lineIdx) => {
                const div = document.createElement('div');
                div.className = 'line-group';
                
                const players = line.players.map((p, playerIdx) => {
                    const playerShifts = gameData.shifts.filter(s => s.playerNumber === p.number);
                    const totalTOI = playerShifts.reduce((sum, s) => sum + (s.endTime - s.startTime), 0);
                    const currentTOI = p.onIce ? Date.now() - p.shiftStart : 0;
                    const displayTOI = formatTime((totalTOI + currentTOI) / 1000);
                    
                    return `
                        <div class="player-card ${p.onIce ? 'on-ice' : ''}" onclick="togglePlayer(${lineIdx}, ${playerIdx})" title="Click to toggle this player">
                            <div class="player-number">#${p.number}</div>
                            <div class="player-name">${p.name}</div>
                            <div class="player-toi ${p.onIce ? 'active' : ''}">${displayTOI}</div>
                            ${p.onIce ? '<div class="player-status">ON ICE</div>' : ''}
                        </div>
                    `;
                }).join('');
                
                // Check if entire line is on ice
                const allOnIce = line.players.every(p => p.onIce);
                const anyOnIce = line.players.some(p => p.onIce);
                
                div.innerHTML = `
                    <div class="line-header">
                        <div class="line-title">${line.name}${anyOnIce && !allOnIce ? ' (Mixed)' : ''}</div>
                        <button class="line-toggle ${allOnIce ? 'active' : ''}" onclick="toggleLine(${lineIdx})">
                            ${allOnIce ? 'END LINE' : 'START LINE'}
                        </button>
                    </div>
                    <div class="players-grid">${players}</div>
                `;
                
                section.appendChild(div);
            });
            
            updateSidebar();
        }
        
        function togglePlayer(lineIdx, playerIdx) {
            const player = gameData.lines[lineIdx].players[playerIdx];
            const line = gameData.lines[lineIdx];
            
            if (player.onIce) {
                // End shift for this player
                const shiftEnd = Date.now();
                const shiftLength = shiftEnd - player.shiftStart;
                
                gameData.shifts.push({
                    playerNumber: player.number,
                    playerName: player.name,
                    lineName: line.name,
                    period: gameData.currentPeriod,
                    strength: gameData.currentStrength,
                    startTime: player.shiftStart,
                    endTime: shiftEnd,
                    length: shiftLength,
                    gameClock: gameData.gameClock
                });
                
                player.onIce = false;
                player.shiftStart = null;
            } else {
                // Start shift for this player
                player.onIce = true;
                player.shiftStart = Date.now();
            }
            
            renderLines();
        }
        
        function toggleLine(lineIdx) {
            const line = gameData.lines[lineIdx];
            const allOnIce = line.players.every(p => p.onIce);
            
            if (allOnIce) {
                // End shift for all players in line
                line.players.forEach(player => {
                    if (player.onIce) {
                        const shiftEnd = Date.now();
                        const shiftLength = shiftEnd - player.shiftStart;
                        
                        gameData.shifts.push({
                            playerNumber: player.number,
                            playerName: player.name,
                            lineName: line.name,
                            period: gameData.currentPeriod,
                            strength: gameData.currentStrength,
                            startTime: player.shiftStart,
                            endTime: shiftEnd,
                            length: shiftLength,
                            gameClock: gameData.gameClock
                        });
                        
                        player.onIce = false;
                        player.shiftStart = null;
                    }
                });
            } else {
                // Start shift for all players in line
                const now = Date.now();
                line.players.forEach(player => {
                    if (!player.onIce) {
                        player.onIce = true;
                        player.shiftStart = now;
                    }
                });
            }
            
            renderLines();
        }
        
        function setPeriod(period) {
            gameData.currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx + 1 === period);
            });
            
            if (period <= 3) {
                gameData.gameClock = 1200;
            } else {
                gameData.gameClock = 300;
            }
            pauseClock();
        }
        
        function setStrength(strength) {
            gameData.currentStrength = strength;
            document.querySelectorAll('.strength-btn').forEach(btn => btn.classList.remove('active'));
            const btnMap = { '5v5': 0, 'PP': 1, 'PK': 2 };
            document.querySelectorAll('.strength-btn')[btnMap[strength]].classList.add('active');
        }
        
        function openFaceoffModal() {
            // Reset temp faceoff data
            gameData.faceoffTemp = {
                zone: null,
                player: null,
                result: null,
                clean: null
            };
            
            // Clear all button states
            document.querySelectorAll('#faceoffModal .zone-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#faceoffModal .strength-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('faceoffPlayer').value = '';
            
            document.getElementById('faceoffModal').classList.add('active');
        }
        
        function setFaceoffZone(zone) {
            gameData.faceoffTemp.zone = zone;
            document.querySelectorAll('#faceoffModal .zone-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function setFaceoffResult(result) {
            gameData.faceoffTemp.result = result;
            document.querySelectorAll('#faceoffModal .strength-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function setFaceoffClean(isClean) {
            gameData.faceoffTemp.clean = isClean;
            const buttons = document.querySelectorAll('#faceoffModal .editor-section:last-of-type .zone-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function saveFaceoff() {
            const playerNum = document.getElementById('faceoffPlayer').value;
            
            // Validation
            if (!gameData.faceoffTemp.zone) {
                alert('Please select a zone');
                return;
            }
            if (!playerNum) {
                alert('Please enter player jersey number');
                return;
            }
            if (!gameData.faceoffTemp.result) {
                alert('Please select win or loss');
                return;
            }
            
            // Find player name
            const allPlayers = gameData.lines.flatMap(l => l.players);
            const player = allPlayers.find(p => p.number == playerNum);
            
            gameData.faceoffs.push({
                zone: gameData.faceoffTemp.zone,
                playerNumber: parseInt(playerNum),
                playerName: player ? player.name : '',
                result: gameData.faceoffTemp.result,
                clean: gameData.faceoffTemp.clean,
                period: gameData.currentPeriod,
                strength: gameData.currentStrength,
                time: Date.now(),
                gameClock: gameData.gameClock
            });
            
            updateSidebar();
            closeModal('faceoffModal');
        }
        
        function startClock() {
            if (!gameData.clockRunning) {
                gameData.clockRunning = true;
                gameData.clockInterval = setInterval(() => {
                    if (gameData.gameClock > 0) {
                        gameData.gameClock--;
                    }
                    updateClockDisplay();
                }, 1000);
            }
        }
        
        function pauseClock() {
            gameData.clockRunning = false;
            if (gameData.clockInterval) {
                clearInterval(gameData.clockInterval);
            }
        }
        
        function resetClock() {
            pauseClock();
            gameData.gameClock = gameData.currentPeriod <= 3 ? 1200 : 300;
            updateClockDisplay();
        }
        
        function updateClockDisplay() {
            const minutes = Math.floor(gameData.gameClock / 60);
            const seconds = gameData.gameClock % 60;
            document.getElementById('gameClock').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function openClockEditor(event) {
            event.preventDefault();
            const editor = document.getElementById('clockEditor');
            const minutes = Math.floor(gameData.gameClock / 60);
            const seconds = gameData.gameClock % 60;
            
            document.getElementById('clockMinutes').value = minutes;
            document.getElementById('clockSeconds').value = seconds;
            
            editor.style.left = event.pageX + 'px';
            editor.style.top = event.pageY + 'px';
            editor.classList.add('active');
            
            // Close editor when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeClockEditorOnClickOutside);
            }, 100);
        }
        
        function closeClockEditorOnClickOutside(event) {
            const editor = document.getElementById('clockEditor');
            if (!editor.contains(event.target) && event.target.id !== 'gameClock') {
                closeClockEditor();
            }
        }
        
        function closeClockEditor() {
            document.getElementById('clockEditor').classList.remove('active');
            document.removeEventListener('click', closeClockEditorOnClickOutside);
        }
        
        function setClockManual() {
            const minutes = parseInt(document.getElementById('clockMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('clockSeconds').value) || 0;
            
            gameData.gameClock = minutes * 60 + seconds;
            updateClockDisplay();
            closeClockEditor();
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }
        
        function logGoal(team) {
            let playerNum = null;
            let playerName = '';
            
            if (team === 'us') {
                const onIcePlayers = gameData.lines.flatMap(l => 
                    l.players.filter(p => p.onIce).map(p => ({ number: p.number, name: p.name }))
                );
                
                playerNum = prompt('Goal scored by jersey # (or press Enter to skip):');
                
                // Allow blank entry - just log the goal without player
                if (playerNum !== null && playerNum.trim() !== '') {
                    playerNum = playerNum.trim();
                    const player = onIcePlayers.find(p => p.number == playerNum);
                    playerName = player ? player.name : '';
                } else if (playerNum === null) {
                    // User cancelled
                    return;
                }
                // If empty string, just continue with null player
            }
            
            gameData.events.push({
                type: 'goal',
                team: team,
                playerNumber: playerNum,
                playerName: playerName,
                period: gameData.currentPeriod,
                strength: gameData.currentStrength,
                time: Date.now(),
                gameClock: gameData.gameClock
            });
            
            updateEventsList();
        }
        
        function logShot(team) {
            let playerNum = null;
            let playerName = '';
            
            if (team === 'us') {
                const onIcePlayers = gameData.lines.flatMap(l => 
                    l.players.filter(p => p.onIce).map(p => ({ number: p.number, name: p.name }))
                );
                
                playerNum = prompt('Shot by jersey # (or press Enter to skip):');
                
                // Allow blank entry - just log the shot without player
                if (playerNum !== null && playerNum.trim() !== '') {
                    playerNum = playerNum.trim();
                    const player = onIcePlayers.find(p => p.number == playerNum);
                    playerName = player ? player.name : '';
                } else if (playerNum === null) {
                    // User cancelled
                    return;
                }
                // If empty string, just continue with null player
            }
            
            gameData.events.push({
                type: 'shot',
                team: team,
                playerNumber: playerNum,
                playerName: playerName,
                period: gameData.currentPeriod,
                strength: gameData.currentStrength,
                time: Date.now(),
                gameClock: gameData.gameClock
            });
            
            updateEventsList();
        }
        
        function updateEventsList() {
            const list = document.getElementById('eventsList');
            const recent = gameData.events.slice(-5).reverse();
            
            if (recent.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--bench-gray); padding: 10px; font-size: 0.8rem;">No events logged</div>';
                return;
            }
            
            list.innerHTML = recent.map(e => {
                const clockMin = Math.floor(e.gameClock / 60);
                const clockSec = e.gameClock % 60;
                const clock = `${clockMin}:${String(clockSec).padStart(2, '0')}`;
                const teamLabel = e.team === 'us' ? 'NBC' : 'OPP';
                
                // Build player info - handle both null and empty cases
                let playerInfo = '';
                if (e.playerNumber && e.playerNumber.toString().trim() !== '') {
                    playerInfo = e.playerName 
                        ? `: #${e.playerNumber} ${e.playerName}` 
                        : `: #${e.playerNumber}`;
                }
                
                const oppClass = e.team === 'them' ? 'opponent' : '';
                
                return `
                    <div class="event-item ${e.type} ${oppClass}">
                        <span>${teamLabel} ${e.type.toUpperCase()}${playerInfo}</span>
                        <span>P${e.period} ${clock}</span>
                    </div>
                `;
            }).join('');
        }
        
        function updateSidebar() {
            const totalShifts = gameData.shifts.length;
            document.getElementById('totalShifts').textContent = totalShifts;
            
            const avgShift = totalShifts > 0 
                ? gameData.shifts.reduce((sum, s) => sum + s.length, 0) / totalShifts / 1000
                : 0;
            document.getElementById('avgShift').textContent = formatTime(avgShift);
            
            const longShifts = gameData.shifts.filter(s => s.length > 60000).length;
            document.getElementById('longShifts').textContent = longShifts;
            
            const ourGoals = gameData.events.filter(e => e.type === 'goal' && e.team === 'us').length;
            const theirGoals = gameData.events.filter(e => e.type === 'goal' && e.team === 'them').length;
            const ourShots = gameData.events.filter(e => e.type === 'shot' && e.team === 'us').length;
            const theirShots = gameData.events.filter(e => e.type === 'shot' && e.team === 'them').length;
            
            document.getElementById('ourGoals').textContent = ourGoals;
            document.getElementById('theirGoals').textContent = theirGoals;
            document.getElementById('ourShots').textContent = ourShots;
            document.getElementById('theirShots').textContent = theirShots;
            
            // Update header score display
            document.getElementById('scoreUs').textContent = ourGoals;
            document.getElementById('scoreThem').textContent = theirGoals;
            
            // Update faceoff stats
            const totalFO = gameData.faceoffs.length;
            const foWins = gameData.faceoffs.filter(f => f.result === 'W').length;
            const foPct = totalFO > 0 ? ((foWins / totalFO) * 100).toFixed(1) : '0.0';
            
            const oZoneFO = gameData.faceoffs.filter(f => f.zone === 'O');
            const oZoneWins = oZoneFO.filter(f => f.result === 'W').length;
            
            const nZoneFO = gameData.faceoffs.filter(f => f.zone === 'N');
            const nZoneWins = nZoneFO.filter(f => f.result === 'W').length;
            
            const dZoneFO = gameData.faceoffs.filter(f => f.zone === 'D');
            const dZoneWins = dZoneFO.filter(f => f.result === 'W').length;
            
            const cleanWins = gameData.faceoffs.filter(f => f.result === 'W' && f.clean === true).length;
            
            document.getElementById('totalFaceoffs').textContent = totalFO;
            document.getElementById('faceoffPct').textContent = foPct + '%';
            document.getElementById('oZoneFO').textContent = `${oZoneWins}-${oZoneFO.length - oZoneWins}`;
            document.getElementById('nZoneFO').textContent = `${nZoneWins}-${nZoneFO.length - nZoneWins}`;
            document.getElementById('dZoneFO').textContent = `${dZoneWins}-${dZoneFO.length - dZoneWins}`;
            document.getElementById('cleanWins').textContent = cleanWins;
        }
        
        function openLineEditor() {
            const modal = document.getElementById('lineEditorModal');
            const content = document.getElementById('lineEditorContent');
            
            content.innerHTML = gameData.lines.map((line, lineIdx) => `
                <div class="editor-section">
                    <div class="editor-section-title">${line.name}</div>
                    ${line.players.map((player, playerIdx) => `
                        <div class="player-editor">
                            <input type="number" value="${player.number}" 
                                   onchange="updatePlayer(${lineIdx}, ${playerIdx}, 'number', this.value)">
                            <input type="text" value="${player.name}" 
                                   onchange="updatePlayer(${lineIdx}, ${playerIdx}, 'name', this.value)">
                            <span style="color: var(--bench-gray);">${player.position}</span>
                        </div>
                    `).join('')}
                </div>
            `).join('');
            
            modal.classList.add('active');
        }
        
        function updatePlayer(lineIdx, playerIdx, field, value) {
            if (field === 'number') {
                gameData.lines[lineIdx].players[playerIdx][field] = parseInt(value);
            } else {
                gameData.lines[lineIdx].players[playerIdx][field] = value;
            }
        }
        
        function saveLineConfig() {
            // Strip out tracking state before saving config
            const configToSave = {
                lines: gameData.lines.map(line => ({
                    ...line,
                    onIce: false,
                    shiftStart: null,
                    players: line.players.map(player => ({
                        number: player.number,
                        name: player.name,
                        position: player.position,
                        onIce: false,
                        shiftStart: null
                    }))
                })),
                gameInfo: gameData.gameInfo
            };
            
            localStorage.setItem('hockeyTrackerConfig', JSON.stringify(configToSave));
            
            const blob = new Blob([JSON.stringify(configToSave, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hockey-tracker-config.json';
            a.click();
            
            alert('Configuration saved to browser and downloaded as file!');
        }
        
        function loadLineConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const config = JSON.parse(event.target.result);
                        
                        // Ensure player tracking state is properly initialized
                        if (config.lines) {
                            gameData.lines = config.lines.map(line => ({
                                ...line,
                                onIce: false,
                                shiftStart: null,
                                players: line.players.map(player => ({
                                    ...player,
                                    onIce: false,
                                    shiftStart: null
                                }))
                            }));
                        }
                        
                        gameData.gameInfo = config.gameInfo || gameData.gameInfo;
                        localStorage.setItem('hockeyTrackerConfig', JSON.stringify(config));
                        renderLines();
                        alert('Configuration loaded successfully!');
                        closeModal('lineEditorModal');
                    } catch (err) {
                        alert('Error loading configuration: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function openConfigModal() {
            const modal = document.getElementById('configModal');
            document.getElementById('gameDate').value = gameData.gameInfo.date;
            document.getElementById('opponent').value = gameData.gameInfo.opponent;
            document.getElementById('location').value = gameData.gameInfo.location;
            modal.classList.add('active');
        }
        
        function saveGameInfo() {
            gameData.gameInfo.date = document.getElementById('gameDate').value;
            gameData.gameInfo.opponent = document.getElementById('opponent').value;
            gameData.gameInfo.location = document.getElementById('location').value;
            alert('Game info saved!');
        }
        
        function importVideoTimestamps() {
            const text = document.getElementById('videoTimestamps').value;
            const lines = text.split('\n').filter(l => l.trim());
            
            gameData.videoTimestamps = lines.map(line => {
                const parts = line.trim().split(':').map(p => parseInt(p));
                if (parts.length === 2) {
                    return parts[0] * 60 + parts[1]; // MM:SS
                } else if (parts.length === 3) {
                    return parts[0] * 3600 + parts[1] * 60 + parts[2]; // HH:MM:SS
                }
                return 0;
            });
            
            alert(`Imported ${gameData.videoTimestamps.length} video timestamps!`);
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function exportCSV() {
            let csv = `Game Info\nDate,${gameData.gameInfo.date}\nOpponent,${gameData.gameInfo.opponent}\nLocation,${gameData.gameInfo.location}\n\n`;
            csv += 'Player,Name,Line,Period,Strength,Shift Start,Shift End,Length (sec),Game Clock,Video TS\n';
            
            gameData.shifts.forEach((shift, idx) => {
                const startTime = new Date(shift.startTime).toLocaleTimeString();
                const endTime = new Date(shift.endTime).toLocaleTimeString();
                const lengthSec = (shift.length / 1000).toFixed(1);
                const clockMin = Math.floor(shift.gameClock / 60);
                const clockSec = shift.gameClock % 60;
                const clock = `${clockMin}:${String(clockSec).padStart(2, '0')}`;
                const videoTS = gameData.videoTimestamps[idx] ? formatTime(gameData.videoTimestamps[idx]) : '';
                
                csv += `#${shift.playerNumber},${shift.playerName},${shift.lineName},P${shift.period},${shift.strength},${startTime},${endTime},${lengthSec},${clock},${videoTS}\n`;
            });
            
            csv += '\n\nPlayer Summary\n';
            csv += 'Player,Name,Total Shifts,Total TOI (min),Avg Shift (sec),5v5 TOI,PP TOI,PK TOI\n';
            
            const allPlayers = gameData.lines.flatMap(l => l.players);
            const uniquePlayers = [...new Map(allPlayers.map(p => [p.number, p])).values()];
            
            uniquePlayers.forEach(player => {
                const playerShifts = gameData.shifts.filter(s => s.playerNumber === player.number);
                if (playerShifts.length === 0) return;
                const totalTOI = playerShifts.reduce((sum, s) => sum + s.length, 0);
                const avgShift = totalTOI / playerShifts.length / 1000;
                
                const toi5v5 = playerShifts.filter(s => s.strength === '5v5').reduce((sum, s) => sum + s.length, 0);
                const toiPP = playerShifts.filter(s => s.strength === 'PP').reduce((sum, s) => sum + s.length, 0);
                const toiPK = playerShifts.filter(s => s.strength === 'PK').reduce((sum, s) => sum + s.length, 0);
                
                csv += `#${player.number},${player.name},${playerShifts.length},${(totalTOI / 60000).toFixed(2)},${avgShift.toFixed(1)},${(toi5v5 / 60000).toFixed(2)},${(toiPP / 60000).toFixed(2)},${(toiPK / 60000).toFixed(2)}\n`;
            });
            
            csv += '\n\nFaceoffs\n';
            csv += 'Player,Name,Zone,Result,Clean/Help,Period,Strength,Time,Game Clock\n';
            gameData.faceoffs.forEach(fo => {
                const clockMin = Math.floor(fo.gameClock / 60);
                const clockSec = fo.gameClock % 60;
                const clock = `${clockMin}:${String(clockSec).padStart(2, '0')}`;
                const time = new Date(fo.time).toLocaleTimeString();
                const zoneName = fo.zone === 'O' ? 'Offensive' : fo.zone === 'N' ? 'Neutral' : 'Defensive';
                const cleanHelp = fo.result === 'W' ? (fo.clean ? 'Clean' : 'Help') : '-';
                csv += `#${fo.playerNumber},${fo.playerName},${zoneName},${fo.result === 'W' ? 'Win' : 'Loss'},${cleanHelp},P${fo.period},${fo.strength},${time},${clock}\n`;
            });
            
            csv += '\n\nFaceoff Summary by Player\n';
            csv += 'Player,Name,Total FO,Wins,Losses,Win %,O-Zone,N-Zone,D-Zone,Clean Wins\n';
            uniquePlayers.forEach(player => {
                const playerFO = gameData.faceoffs.filter(f => f.playerNumber === player.number);
                if (playerFO.length === 0) return;
                
                const wins = playerFO.filter(f => f.result === 'W').length;
                const losses = playerFO.length - wins;
                const winPct = ((wins / playerFO.length) * 100).toFixed(1);
                const oZone = `${playerFO.filter(f => f.zone === 'O' && f.result === 'W').length}-${playerFO.filter(f => f.zone === 'O' && f.result === 'L').length}`;
                const nZone = `${playerFO.filter(f => f.zone === 'N' && f.result === 'W').length}-${playerFO.filter(f => f.zone === 'N' && f.result === 'L').length}`;
                const dZone = `${playerFO.filter(f => f.zone === 'D' && f.result === 'W').length}-${playerFO.filter(f => f.zone === 'D' && f.result === 'L').length}`;
                const clean = playerFO.filter(f => f.result === 'W' && f.clean === true).length;
                
                csv += `#${player.number},${player.name},${playerFO.length},${wins},${losses},${winPct}%,${oZone},${nZone},${dZone},${clean}\n`;
            });
            
            csv += '\n\nEvents\n';
            csv += 'Team,Type,Player,Period,Strength,Time,Game Clock\n';
            gameData.events.forEach(event => {
                const clockMin = Math.floor(event.gameClock / 60);
                const clockSec = event.gameClock % 60;
                const clock = `${clockMin}:${String(clockSec).padStart(2, '0')}`;
                const time = new Date(event.time).toLocaleTimeString();
                const team = event.team === 'us' ? 'NBC' : 'OPP';
                const player = (event.playerNumber && event.playerNumber.toString().trim()) 
                    ? (event.playerName ? `#${event.playerNumber} ${event.playerName}` : `#${event.playerNumber}`)
                    : '';
                csv += `${team},${event.type},${player},P${event.period},${event.strength},${time},${clock}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shift-tracker-${gameData.gameInfo.date || new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }
        
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.text('Hockey Shift Tracker Report', 105, 15, { align: 'center' });
            
            // Score
            const ourGoals = gameData.events.filter(e => e.type === 'goal' && e.team === 'us').length;
            const theirGoals = gameData.events.filter(e => e.type === 'goal' && e.team === 'them').length;
            doc.setFontSize(16);
            doc.text(`Final Score: Newburyport ${ourGoals} - ${theirGoals} ${gameData.gameInfo.opponent || 'Opponent'}`, 105, 22, { align: 'center' });
            
            // Game Info
            doc.setFontSize(12);
            doc.text(`Date: ${gameData.gameInfo.date || 'N/A'}`, 20, 35);
            doc.text(`Opponent: ${gameData.gameInfo.opponent || 'N/A'}`, 20, 42);
            doc.text(`Location: ${gameData.gameInfo.location || 'N/A'}`, 20, 49);
            
            let yPosition = 60;
            
            // Period-by-Period TOI Reports (Catapult Style)
            for (let period = 1; period <= 4; period++) {
                const periodShifts = gameData.shifts.filter(s => s.period === period);
                if (periodShifts.length === 0) continue;
                
                // Check if we need a new page
                if (yPosition > 240) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(14);
                doc.text(`Period ${period}`, 20, yPosition);
                yPosition += 5;
                
                // Calculate per-player stats for this period
                const allPlayers = gameData.lines.flatMap(l => l.players);
                const uniquePlayers = [...new Map(allPlayers.map(p => [p.number, p])).values()];
                
                const periodData = uniquePlayers.map(player => {
                    const playerShifts = periodShifts.filter(s => s.playerNumber === player.number);
                    
                    if (playerShifts.length === 0) {
                        return [
                            `${player.number}`,
                            player.name,
                            0,
                            '00:00',
                            '00:00',
                            '00:00',
                            '00:00',
                            '00:00'
                        ];
                    }
                    
                    const totalTOI = playerShifts.reduce((sum, s) => sum + s.length, 0);
                    const toi5v5 = playerShifts.filter(s => s.strength === '5v5').reduce((sum, s) => sum + s.length, 0);
                    const toiPP = playerShifts.filter(s => s.strength === 'PP').reduce((sum, s) => sum + s.length, 0);
                    const toiPK = playerShifts.filter(s => s.strength === 'PK').reduce((sum, s) => sum + s.length, 0);
                    const avgEven = playerShifts.filter(s => s.strength === '5v5').length > 0
                        ? toi5v5 / playerShifts.filter(s => s.strength === '5v5').length
                        : 0;
                    
                    return [
                        `${player.number}`,
                        player.name,
                        playerShifts.length,
                        formatTime(totalTOI / 1000),
                        formatTime(toi5v5 / 1000),
                        formatTime(toiPP / 1000),
                        formatTime(toiPK / 1000),
                        formatTime(avgEven / 1000)
                    ];
                }).filter(row => row[2] > 0); // Only include players who played
                
                doc.autoTable({
                    startY: yPosition,
                    head: [['#', 'Player', 'Shifts', 'Total', 'Even', 'PP', 'PK', 'Even Avg']],
                    body: periodData,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [0, 102, 204] }
                });
                
                yPosition = doc.lastAutoTable.finalY + 15;
            }
            
            // New page for game totals
            doc.addPage();
            doc.setFontSize(16);
            doc.text('Game Totals', 20, 20);
            
            // Calculate game totals
            const allPlayers = gameData.lines.flatMap(l => l.players);
            const uniquePlayers = [...new Map(allPlayers.map(p => [p.number, p])).values()];
            
            const gameTotalData = uniquePlayers.map(player => {
                const playerShifts = gameData.shifts.filter(s => s.playerNumber === player.number);
                
                if (playerShifts.length === 0) {
                    return null;
                }
                
                const totalTOI = playerShifts.reduce((sum, s) => sum + s.length, 0);
                const toi5v5 = playerShifts.filter(s => s.strength === '5v5').reduce((sum, s) => sum + s.length, 0);
                const toiPP = playerShifts.filter(s => s.strength === 'PP').reduce((sum, s) => sum + s.length, 0);
                const toiPK = playerShifts.filter(s => s.strength === 'PK').reduce((sum, s) => sum + s.length, 0);
                const avgEven = playerShifts.filter(s => s.strength === '5v5').length > 0
                    ? toi5v5 / playerShifts.filter(s => s.strength === '5v5').length
                    : 0;
                
                return [
                    `${player.number}`,
                    player.name,
                    playerShifts.length,
                    formatTime(totalTOI / 1000),
                    formatTime(toi5v5 / 1000),
                    formatTime(toiPP / 1000),
                    formatTime(toiPK / 1000),
                    formatTime(avgEven / 1000)
                ];
            }).filter(row => row !== null);
            
            doc.autoTable({
                startY: 30,
                head: [['#', 'Player', 'Shifts', 'Total', 'Even', 'PP', 'PK', 'Even Avg']],
                body: gameTotalData,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [0, 102, 204] }
            });
            
            // Event Summary by Player
            if (gameData.events.length > 0) {
                doc.addPage();
                doc.setFontSize(16);
                doc.text('Event Summary', 20, 20);
                
                // Calculate event totals per player
                const playerEventData = uniquePlayers.map(player => {
                    const goals = gameData.events.filter(e => 
                        e.type === 'goal' && e.team === 'us' && 
                        e.playerNumber && e.playerNumber.toString().trim() !== '' &&
                        e.playerNumber == player.number
                    ).length;
                    const shots = gameData.events.filter(e => 
                        e.type === 'shot' && e.team === 'us' && 
                        e.playerNumber && e.playerNumber.toString().trim() !== '' &&
                        e.playerNumber == player.number
                    ).length;
                    
                    if (goals === 0 && shots === 0) return null;
                    
                    return [
                        `${player.number}`,
                        player.name,
                        goals,
                        shots,
                        shots > 0 ? ((goals / shots) * 100).toFixed(1) + '%' : '-'
                    ];
                }).filter(row => row !== null);
                
                if (playerEventData.length > 0) {
                    doc.autoTable({
                        startY: 30,
                        head: [['#', 'Player', 'Goals', 'Shots', 'Shooting %']],
                        body: playerEventData,
                        theme: 'grid',
                        styles: { fontSize: 10 },
                        headStyles: { fillColor: [0, 230, 118] }
                    });
                }
                
                // Goal Timeline
                const goals = gameData.events.filter(e => e.type === 'goal');
                if (goals.length > 0) {
                    const yPos = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : 80;
                    doc.setFontSize(14);
                    doc.text('Goal Timeline', 20, yPos);
                    
                    const goalData = goals.map(e => {
                        const clockMin = Math.floor(e.gameClock / 60);
                        const clockSec = e.gameClock % 60;
                        const clock = `${clockMin}:${String(clockSec).padStart(2, '0')}`;
                        const team = e.team === 'us' ? 'NBC' : gameData.gameInfo.opponent || 'OPP';
                        
                        let player = 'Unknown';
                        if (e.playerNumber && e.playerNumber.toString().trim() !== '') {
                            player = e.playerName ? `#${e.playerNumber} ${e.playerName}` : `#${e.playerNumber}`;
                        }
                        
                        return [
                            `P${e.period}`,
                            clock,
                            team,
                            player,
                            e.strength
                        ];
                    });
                    
                    doc.autoTable({
                        startY: yPos + 5,
                        head: [['Period', 'Time', 'Team', 'Scorer', 'Strength']],
                        body: goalData,
                        theme: 'grid',
                        styles: { fontSize: 9 },
                        headStyles: { fillColor: [26, 35, 50] }
                    });
                    
                    // Team totals after goal timeline
                    const teamYPos = doc.lastAutoTable.finalY + 15;
                    doc.setFontSize(14);
                    doc.text('Team Totals', 20, teamYPos);
                    
                    const teamData = [
                        ['Newburyport', ourGoals, gameData.events.filter(e => e.type === 'shot' && e.team === 'us').length],
                        [gameData.gameInfo.opponent || 'Opponent', theirGoals, gameData.events.filter(e => e.type === 'shot' && e.team === 'them').length]
                    ];
                    
                    doc.autoTable({
                        startY: teamYPos + 5,
                        head: [['Team', 'Goals', 'Shots']],
                        body: teamData,
                        theme: 'grid',
                        styles: { fontSize: 11 },
                        headStyles: { fillColor: [26, 35, 50] }
                    });
                } else {
                    // Team totals if no goals
                    const yPos = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : 80;
                    doc.setFontSize(14);
                    doc.text('Team Totals', 20, yPos);
                    
                    const teamData = [
                        ['Newburyport', ourGoals, gameData.events.filter(e => e.type === 'shot' && e.team === 'us').length],
                        [gameData.gameInfo.opponent || 'Opponent', theirGoals, gameData.events.filter(e => e.type === 'shot' && e.team === 'them').length]
                    ];
                    
                    doc.autoTable({
                        startY: yPos + 5,
                        head: [['Team', 'Goals', 'Shots']],
                        body: teamData,
                        theme: 'grid',
                        styles: { fontSize: 11 },
                        headStyles: { fillColor: [26, 35, 50] }
                    });
                }
            }
            
            // Faceoff Summary
            if (gameData.faceoffs.length > 0) {
                doc.addPage();
                doc.setFontSize(16);
                doc.text('Faceoff Report', 20, 20);
                
                // Group players by line for faceoff report
                const lineGroups = [];
                gameData.lines.forEach(line => {
                    const lineData = {
                        lineName: line.name,
                        players: []
                    };
                    
                    line.players.forEach(player => {
                        const playerFO = gameData.faceoffs.filter(f => f.playerNumber === player.number);
                        if (playerFO.length > 0) {
                            // Calculate zone √ó strength matrix
                            const calc = (zone, strength) => {
                                const filtered = playerFO.filter(f => f.zone === zone && f.strength === strength);
                                const wins = filtered.filter(f => f.result === 'W').length;
                                const total = filtered.length;
                                const pct = total > 0 ? ((wins / total) * 100).toFixed(0) : '0';
                                return total > 0 ? `${wins}-${total - wins} ${pct}%` : '-';
                            };
                            
                            const calcZone = (zone) => {
                                const filtered = playerFO.filter(f => f.zone === zone);
                                const wins = filtered.filter(f => f.result === 'W').length;
                                const total = filtered.length;
                                const pct = total > 0 ? ((wins / total) * 100).toFixed(0) : '0';
                                return total > 0 ? `${wins}-${total - wins} ${pct}%` : '-';
                            };
                            
                            const calcStrength = (strength) => {
                                const filtered = playerFO.filter(f => f.strength === strength);
                                const wins = filtered.filter(f => f.result === 'W').length;
                                const total = filtered.length;
                                const pct = total > 0 ? ((wins / total) * 100).toFixed(0) : '0';
                                return total > 0 ? `${wins}-${total - wins} ${pct}%` : '-';
                            };
                            
                            const totalWins = playerFO.filter(f => f.result === 'W').length;
                            const totalFO = playerFO.length;
                            const totalPct = ((totalWins / totalFO) * 100).toFixed(0);
                            
                            lineData.players.push({
                                name: `${player.number} ${player.name}`,
                                oZone: calcZone('O'),
                                nZone: calcZone('N'),
                                dZone: calcZone('D'),
                                even: calcStrength('5v5'),
                                pp: calcStrength('PP'),
                                pk: calcStrength('PK'),
                                total: `${totalWins}-${totalFO - totalWins} ${totalPct}%`
                            });
                        }
                    });
                    
                    if (lineData.players.length > 0) {
                        lineGroups.push(lineData);
                    }
                });
                
                // Build table with line grouping
                let yPos = 30;
                lineGroups.forEach((lineGroup, idx) => {
                    // Check if we need a new page
                    if (yPos > 240) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Line header
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text(lineGroup.lineName, 20, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 5;
                    
                    // Player data for this line
                    const tableData = lineGroup.players.map(p => [
                        p.name,
                        p.oZone,
                        p.nZone,
                        p.dZone,
                        p.even,
                        p.pp,
                        p.pk,
                        p.total
                    ]);
                    
                    doc.autoTable({
                        startY: yPos,
                        head: idx === 0 ? [['Player', 'OZ', 'NZ', 'DZ', 'EVEN', 'PP', 'PK', 'TOTAL']] : [],
                        body: tableData,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 2 },
                        headStyles: { fillColor: [0, 102, 204], fontSize: 8 },
                        columnStyles: {
                            0: { cellWidth: 35 },
                            1: { cellWidth: 20 },
                            2: { cellWidth: 20 },
                            3: { cellWidth: 20 },
                            4: { cellWidth: 20 },
                            5: { cellWidth: 20 },
                            6: { cellWidth: 20 },
                            7: { cellWidth: 25 }
                        }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 10;
                });
                
                // Team totals at bottom
                if (yPos > 220) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('TEAM TOTALS', 20, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 5;
                
                // Calculate team totals
                const calcTeamZone = (zone) => {
                    const filtered = gameData.faceoffs.filter(f => f.zone === zone);
                    const wins = filtered.filter(f => f.result === 'W').length;
                    const total = filtered.length;
                    const pct = total > 0 ? ((wins / total) * 100).toFixed(0) : '0';
                    return total > 0 ? `${wins}-${total - wins} ${pct}%` : '0-0 0%';
                };
                
                const calcTeamStrength = (strength) => {
                    const filtered = gameData.faceoffs.filter(f => f.strength === strength);
                    const wins = filtered.filter(f => f.result === 'W').length;
                    const total = filtered.length;
                    const pct = total > 0 ? ((wins / total) * 100).toFixed(0) : '0';
                    return total > 0 ? `${wins}-${total - wins} ${pct}%` : '0-0 0%';
                };
                
                const totalWins = gameData.faceoffs.filter(f => f.result === 'W').length;
                const totalFO = gameData.faceoffs.length;
                const totalPct = totalFO > 0 ? ((totalWins / totalFO) * 100).toFixed(0) : '0';
                
                const teamTotals = [[
                    'ALL',
                    calcTeamZone('O'),
                    calcTeamZone('N'),
                    calcTeamZone('D'),
                    calcTeamStrength('5v5'),
                    calcTeamStrength('PP'),
                    calcTeamStrength('PK'),
                    `${totalWins}-${totalFO - totalWins} ${totalPct}%`
                ]];
                
                doc.autoTable({
                    startY: yPos,
                    body: teamTotals,
                    theme: 'grid',
                    styles: { fontSize: 9, cellPadding: 2, fontStyle: 'bold' },
                    columnStyles: {
                        0: { cellWidth: 35, fillColor: [220, 220, 220] },
                        1: { cellWidth: 20 },
                        2: { cellWidth: 20 },
                        3: { cellWidth: 20 },
                        4: { cellWidth: 20 },
                        5: { cellWidth: 20 },
                        6: { cellWidth: 20 },
                        7: { cellWidth: 25 }
                    }
                });
            }
            
            doc.save(`shift-tracker-${gameData.gameInfo.date || new Date().toISOString().slice(0,10)}.pdf`);
        }
        
        function clearData() {
            if (!confirm('Clear all shift and event data? Line configuration will be preserved.')) return;
            
            gameData.shifts = [];
            gameData.events = [];
            gameData.faceoffs = [];
            gameData.lines.forEach(line => {
                line.onIce = false;
                line.shiftStart = null;
                line.players.forEach(player => {
                    player.onIce = false;
                    player.shiftStart = null;
                });
            });
            gameData.videoTimestamps = [];
            
            pauseClock();
            resetClock();
            renderLines();
            updateEventsList();
        }
        
        // Initialize
        renderLines();
        updateClockDisplay();
        updateEventsList();
        setInterval(updateSidebar, 100);

        // Expose game tracker functions globally
        window.setPeriod = setPeriod;
        window.setStrength = setStrength;
        window.startClock = startClock;
        window.pauseClock = pauseClock;
        window.resetClock = resetClock;
        window.setClockManual = setClockManual;
        window.closeClockEditor = closeClockEditor;
        window.logGoal = logGoal;
        window.logShot = logShot;
        window.openFaceoffModal = openFaceoffModal;
        window.setFaceoffZone = setFaceoffZone;
        window.setFaceoffResult = setFaceoffResult;
        window.setFaceoffClean = setFaceoffClean;
        window.saveFaceoff = saveFaceoff;
        window.openLineEditor = openLineEditor;
        window.saveLineConfig = saveLineConfig;
        window.loadLineConfig = loadLineConfig;
        window.openConfigModal = openConfigModal;
        window.saveGameInfo = saveGameInfo;
        window.importVideoTimestamps = importVideoTimestamps;
        window.closeModal = closeModal;
        window.exportCSV = exportCSV;
        window.exportPDF = exportPDF;
        window.clearData = clearData;
        window.toggleLine = toggleLine;
        window.togglePlayer = togglePlayer;
    </script>
</div>


<script>
// ==================== FIREBASE INITIALIZATION ====================
const firebaseConfig = {
  apiKey: "AIzaSyBDKRpYsF_awSJy83Icqsq13piBydJDoPI",
  authDomain: "shift-tracker-1d6ff.firebaseapp.com",
  projectId: "shift-tracker-1d6ff",
  storageBucket: "shift-tracker-1d6ff.firebasestorage.app",
  messagingSenderId: "1069832034770",
  appId: "1:1069832034770:web:d17bbcd4f511743713d00b",
  measurementId: "G-EBKWPQPMP3"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Global state
let currentUser = null;
let currentGameId = null;
let autoSaveInterval = null;

// ==================== AUTHENTICATION ====================
function showLogin() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('signupForm').style.display = 'none';
    clearAuthMessage();
}

function showSignup() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('signupForm').style.display = 'block';
    clearAuthMessage();
}

async function handleLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        showAuthMessage('Please enter email and password', 'error');
        return;
    }
    
    try {
        showAuthMessage('Logging in...', 'success');
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        showAuthMessage(error.message, 'error');
    }
}

async function handleSignup() {
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    
    if (!email || !password) {
        showAuthMessage('Please enter email and password', 'error');
        return;
    }
    
    if (password.length < 6) {
        showAuthMessage('Password must be at least 6 characters', 'error');
        return;
    }
    
    try {
        showAuthMessage('Creating account...', 'success');
        await auth.createUserWithEmailAndPassword(email, password);
    } catch (error) {
        showAuthMessage(error.message, 'error');
    }
}

function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        auth.signOut();
    }
}

function showAuthMessage(message, type) {
    const msgDiv = document.getElementById('authMessage');
    msgDiv.textContent = message;
    msgDiv.className = `auth-message ${type}`;
}

function clearAuthMessage() {
    const msgDiv = document.getElementById('authMessage');
    msgDiv.className = 'auth-message';
    msgDiv.textContent = '';
}

// ==================== AUTH STATE LISTENER ====================
auth.onAuthStateChanged(user => {
    if (user) {
        currentUser = user;
        document.getElementById('userEmailDisplay').textContent = user.email;
        showScreen('homeScreen');
        loadDefaultLines(); // Load Clippers roster
    } else {
        currentUser = null;
        showScreen('authScreen');
    }
});

// ==================== SCREEN MANAGEMENT ====================
function showScreen(screenId) {
    // Hide all screens
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    
    // Show requested screen
    document.getElementById(screenId).classList.add('active');
    
    // Start/stop auto-save based on screen
    if (screenId === 'trackerScreen') {
        startAutoSave();
    } else {
        stopAutoSave();
    }
}

// ==================== GAME MANAGEMENT ====================
function startNewGame() {
    if (confirm('Start a new game?')) {
        // Reset game data
        currentGameId = null;
        gameData = {
            gameInfo: { date: new Date().toISOString().slice(0,10), opponent: '', location: '' },
            currentPeriod: 1,
            currentStrength: '5v5',
            gameClock: 1200,
            clockRunning: false,
            clockInterval: null,
            videoTimestamps: [],
            lines: JSON.parse(JSON.stringify(defaultLines)),
            shifts: [],
            events: [],
            faceoffs: [],
            faceoffTemp: { zone: null, player: null, result: null, clean: null }
        };
        
        showScreen('trackerScreen');
        renderLines();
        updateSidebar();
        updateEventsList();
    }
}

function confirmLeaveGame() {
    if (confirm('Leave this game? Make sure you saved!')) {
        stopAutoSave();
        showScreen('homeScreen');
    }
}

// ==================== CLOUD SAVE/LOAD ====================
async function saveGameNow() {
    if (!currentUser) {
        alert('Not logged in!');
        return;
    }
    
    setSyncStatus('syncing');
    
    try {
        // Generate game ID if new game
        if (!currentGameId) {
            currentGameId = `game_${Date.now()}`;
        }
        
        // Save to Firestore
        await db.collection('users').doc(currentUser.uid).collection('games').doc(currentGameId).set({
            info: gameData.gameInfo,
            shifts: gameData.shifts,
            faceoffs: gameData.faceoffs,
            events: gameData.events,
            lines: gameData.lines,
            currentPeriod: gameData.currentPeriod,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            lastModified: new Date().toISOString()
        });
        
        setSyncStatus('synced');
    } catch (error) {
        console.error('Save error:', error);
        setSyncStatus('error');
        alert('Error saving game: ' + error.message);
    }
}

async function loadGame(gameId) {
    if (!currentUser) return;
    
    try {
        const doc = await db.collection('users').doc(currentUser.uid).collection('games').doc(gameId).get();
        
        if (doc.exists) {
            const data = doc.data();
            currentGameId = gameId;
            
            // Load game data
            gameData = {
                gameInfo: data.info || {},
                currentPeriod: data.currentPeriod || 1,
                currentStrength: '5v5',
                gameClock: 1200,
                clockRunning: false,
                clockInterval: null,
                videoTimestamps: [],
                lines: data.lines || JSON.parse(JSON.stringify(defaultLines)),
                shifts: data.shifts || [],
                events: data.events || [],
                faceoffs: data.faceoffs || [],
                faceoffTemp: { zone: null, player: null, result: null, clean: null }
            };
            
            showScreen('trackerScreen');
            renderLines();
            updateSidebar();
            updateEventsList();
        }
    } catch (error) {
        console.error('Load error:', error);
        alert('Error loading game: ' + error.message);
    }
}

async function deleteGame(gameId) {
    if (!currentUser) return;
    if (!confirm('Delete this game? This cannot be undone!')) return;
    
    try {
        await db.collection('users').doc(currentUser.uid).collection('games').doc(gameId).delete();
        loadGameLibrary(); // Refresh library
    } catch (error) {
        console.error('Delete error:', error);
        alert('Error deleting game: ' + error.message);
    }
}

function startAutoSave() {
    stopAutoSave(); // Clear any existing interval
    autoSaveInterval = setInterval(() => {
        if (gameData.shifts.length > 0) {
            saveGameNow();
        }
    }, 30000); // Every 30 seconds
}

function stopAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
        autoSaveInterval = null;
    }
}

function setSyncStatus(status) {
    const dots = [document.getElementById('syncDot'), document.getElementById('trackerSyncDot')];
    const texts = [document.getElementById('syncStatus'), document.getElementById('trackerSyncStatus')];
    
    dots.forEach(dot => {
        if (!dot) return;
        if (status === 'syncing') {
            dot.classList.add('syncing');
        } else {
            dot.classList.remove('syncing');
        }
    });
    
    texts.forEach(text => {
        if (!text) return;
        if (status === 'syncing') {
            text.textContent = 'Saving...';
        } else if (status === 'synced') {
            text.textContent = 'Synced ‚úì';
        } else if (status === 'error') {
            text.textContent = 'Error!';
        } else {
            text.textContent = 'Ready';
        }
    });
}

// ==================== GAME LIBRARY ====================
async function showGameLibrary() {
    showScreen('libraryScreen');
    loadGameLibrary();
}

async function loadGameLibrary() {
    if (!currentUser) return;
    
    document.getElementById('gameLibraryLoading').style.display = 'block';
    document.getElementById('gameLibraryContent').style.display = 'none';
    
    try {
        const snapshot = await db.collection('users').doc(currentUser.uid).collection('games')
            .orderBy('timestamp', 'desc')
            .limit(50)
            .get();
        
        document.getElementById('gameLibraryLoading').style.display = 'none';
        document.getElementById('gameLibraryContent').style.display = 'block';
        
        if (snapshot.empty) {
            document.getElementById('gameList').innerHTML = '';
            document.getElementById('emptyLibrary').style.display = 'block';
        } else {
            document.getElementById('emptyLibrary').style.display = 'none';
            
            let html = '';
            snapshot.forEach(doc => {
                const game = doc.data();
                const date = game.info?.date || 'No date';
                const opponent = game.info?.opponent || 'Unknown opponent';
                const location = game.info?.location || '';
                const shiftsCount = game.shifts?.length || 0;
                
                html += `
                    <div class="game-item">
                        <div class="game-info">
                            <div class="game-title">${opponent}</div>
                            <div class="game-meta">${date} ‚Ä¢ ${location} ‚Ä¢ ${shiftsCount} shifts</div>
                        </div>
                        <div class="game-actions">
                            <button class="btn-small" onclick="loadGame('${doc.id}')">Load</button>
                            <button class="btn-small danger" onclick="deleteGame('${doc.id}')">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('gameList').innerHTML = html;
        }
    } catch (error) {
        console.error('Library error:', error);
        document.getElementById('gameLibraryLoading').style.display = 'none';
        alert('Error loading library: ' + error.message);
    }
}

// ==================== ALL ORIGINAL GAME LOGIC ====================
        let gameData = {
            gameInfo: {
                date: '',
                opponent: '',
                location: ''
            },
            currentPeriod: 1,
            currentStrength: '5v5',
            gameClock: 1200,
            clockRunning: false,
            clockInterval: null,
            videoTimestamps: [],
            lines: [
                { name: 'Line 1', type: 'forward', players: [
                    { number: 5, name: 'Mongeau', position: 'F', onIce: false, shiftStart: null },
                    { number: 7, name: 'Pons', position: 'F', onIce: false, shiftStart: null },
                    { number: 8, name: 'Arel', position: 'F', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'Line 2', type: 'forward', players: [
                    { number: 9, name: 'Sullivan', position: 'F', onIce: false, shiftStart: null },
                    { number: 18, name: 'Curran', position: 'F', onIce: false, shiftStart: null },
                    { number: 23, name: 'Barbera', position: 'F', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'Line 3', type: 'forward', players: [
                    { number: 6, name: 'MacIsaac', position: 'F', onIce: false, shiftStart: null },
                    { number: 15, name: 'Gagnon', position: 'F', onIce: false, shiftStart: null },
                    { number: 24, name: 'Waddell', position: 'F', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'Line 4', type: 'forward', players: [
                    { number: 11, name: 'Bavaro', position: 'F', onIce: false, shiftStart: null },
                    { number: 21, name: 'Donovan', position: 'F', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'D-Pair 1', type: 'defense', players: [
                    { number: 2, name: 'Becker', position: 'D', onIce: false, shiftStart: null },
                    { number: 20, name: 'Gudaitis', position: 'D', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'D-Pair 2', type: 'defense', players: [
                    { number: 10, name: 'Bergeron', position: 'D', onIce: false, shiftStart: null },
                    { number: 12, name: 'Thorne', position: 'D', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'D-Pair 3', type: 'defense', players: [
                    { number: 16, name: 'Varay', position: 'D', onIce: false, shiftStart: null },
                    { number: 17, name: 'Tramontana', position: 'D', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null },
                { name: 'Extra D', type: 'defense', players: [
                    { number: 19, name: 'DesRosiers', position: 'D', onIce: false, shiftStart: null },
                    { number: 27, name: 'Puleo', position: 'D', onIce: false, shiftStart: null }
                ], onIce: false, shiftStart: null }
            ],
            shifts: [],
            events: [],
            faceoffs: [],
            faceoffTemp: {
                zone: null,
                player: null,
                result: null,
                clean: null
            }
        };
        
        // Load saved config on startup
        const savedConfig = localStorage.getItem('hockeyTrackerConfig');
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            if (config.lines) {
                gameData.lines = config.lines.map(line => ({
                    ...line,
                    onIce: false,
                    shiftStart: null,
                    players: line.players.map(player => ({
                        ...player,
                        onIce: false,
                        shiftStart: null
                    }))
                }));
            }
            gameData.gameInfo = config.gameInfo || gameData.gameInfo;
        }
        
        function renderLines() {
            const section = document.getElementById('linesSection');
            section.innerHTML = '';
            
            gameData.lines.forEach((line, lineIdx) => {
                const div = document.createElement('div');
                div.className = 'line-group';
                
                const players = line.players.map((p, playerIdx) => {
                    const playerShifts = gameData.shifts.filter(s => s.playerNumber === p.number);
                    const totalTOI = playerShifts.reduce((sum, s) => sum + (s.endTime - s.startTime), 0);
                    const currentTOI = p.onIce ? Date.now() - p.shiftStart : 0;
                    const displayTOI = formatTime((totalTOI + currentTOI) / 1000);
                    
                    return `
                        <div class="player-card ${p.onIce ? 'on-ice' : ''}" onclick="togglePlayer(${lineIdx}, ${playerIdx})" title="Click to toggle this player">
                            <div class="player-number">#${p.number}</div>
                            <div class="player-name">${p.name}</div>
                            <div class="player-toi ${p.onIce ? 'active' : ''}">${displayTOI}</div>
                            ${p.onIce ? '<div class="player-status">ON ICE</div>' : ''}
                        </div>
                    `;
                }).join('');
                
                // Check if entire line is on ice
                const allOnIce = line.players.every(p => p.onIce);
                const anyOnIce = line.players.some(p => p.onIce);
                
                div.innerHTML = `
                    <div class="line-header">
                        <div class="line-title">${line.name}${anyOnIce && !allOnIce ? ' (Mixed)' : ''}</div>
                        <button class="line-toggle ${allOnIce ? 'active' : ''}" onclick="toggleLine(${lineIdx})">
                            ${allOnIce ? 'END LINE' : 'START LINE'}
                        </button>
                    </div>
                    <div class="players-grid">${players}</div>
                `;
                
                section.appendChild(div);
            });
            
            updateSidebar();
        }
        
        function togglePlayer(lineIdx, playerIdx) {
            const player = gameData.lines[lineIdx].players[playerIdx];
            const line = gameData.lines[lineIdx];
            
            if (player.onIce) {
                // End shift for this player
                const shiftEnd = Date.now();
                const shiftLength = shiftEnd - player.shiftStart;
                
                gameData.shifts.push({
                    playerNumber: player.number,
                    playerName: player.name,
                    lineName: line.name,
                    period: gameData.currentPeriod,
                    strength: gameData.currentStrength,
                    startTime: player.shiftStart,
                    endTime: shiftEnd,
                    length: shiftLength,
                    gameClock: gameData.gameClock
                });
                
                player.onIce = false;
                player.shiftStart = null;
            } else {
                // Start shift for this player
                player.onIce = true;
                player.shiftStart = Date.now();
            }
            
            renderLines();
        }
        
        function toggleLine(lineIdx) {
            const line = gameData.lines[lineIdx];
            const allOnIce = line.players.every(p => p.onIce);
            
            if (allOnIce) {
                // End shift for all players in line
                line.players.forEach(player => {
                    if (player.onIce) {
                        const shiftEnd = Date.now();
                        const shiftLength = shiftEnd - player.shiftStart;
                        
                        gameData.shifts.push({
                            playerNumber: player.number,
                            playerName: player.name,
                            lineName: line.name,
                            period: gameData.currentPeriod,
                            strength: gameData.currentStrength,
                            startTime: player.shiftStart,
                            endTime: shiftEnd,
                            length: shiftLength,
                            gameClock: gameData.gameClock
                        });
                        
                        player.onIce = false;
                        player.shiftStart = null;
                    }
                });
            } else {
                // Start shift for all players in line
                const now = Date.now();
                line.players.forEach(player => {
                    if (!player.onIce) {
                        player.onIce = true;
                        player.shiftStart = now;
                    }
                });
            }
            
            renderLines();
        }
        
        function setPeriod(period) {
            gameData.currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx + 1 === period);
            });
            
            if (period <= 3) {
                gameData.gameClock = 1200;
            } else {
                gameData.gameClock = 300;
            }
            pauseClock();
        }
        
        function setStrength(strength) {
            gameData.currentStrength = strength;
            document.querySelectorAll('.strength-btn').forEach(btn => btn.classList.remove('active'));
            const btnMap = { '5v5': 0, 'PP': 1, 'PK': 2 };
            document.querySelectorAll('.strength-btn')[btnMap[strength]].classList.add('active');
        }
        
        function openFaceoffModal() {
            // Reset temp faceoff data
            gameData.faceoffTemp = {
                zone: null,
                player: null,
                result: null,
                clean: null
            };
            
            // Clear all button states
            document.querySelectorAll('#faceoffModal .zone-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#faceoffModal .strength-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('faceoffPlayer').value = '';
            
            document.getElementById('faceoffModal').classList.add('active');
        }
        
        function setFaceoffZone(zone) {
            gameData.faceoffTemp.zone = zone;
            document.querySelectorAll('#faceoffModal .zone-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function setFaceoffResult(result) {
            gameData.faceoffTemp.result = result;
            document.querySelectorAll('#faceoffModal .strength-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function setFaceoffClean(isClean) {
            gameData.faceoffTemp.clean = isClean;
            const buttons = document.querySelectorAll('#faceoffModal .editor-section:last-of-type .zone-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function saveFaceoff() {
            const playerNum = document.getElementById('faceoffPlayer').value;
            
            // Validation
            if (!gameData.faceoffTemp.zone) {
                alert('Please select a zone');
                return;
            }
            if (!playerNum) {
                alert('Please enter player jersey number');
                return;
            }
            if (!gameData.faceoffTemp.result) {
                alert('Please select win or loss');
                return;
            }
            
            // Find player name
            const allPlayers = gameData.lines.flatMap(l => l.players);
            const player = allPlayers.find(p => p.number == playerNum);
            
            gameData.faceoffs.push({
                zone: gameData.faceoffTemp.zone,
                playerNumber: parseInt(playerNum),
                playerName: player ? player.name : '',
                result: gameData.faceoffTemp.result,
                clean: gameData.faceoffTemp.clean,
                period: gameData.currentPeriod,
                strength: gameData.currentStrength,
                time: Date.now(),
                gameClock: gameData.gameClock
            });
            
            updateSidebar();
            closeModal('faceoffModal');
        }
        
        function startClock() {
            if (!gameData.clockRunning) {
                gameData.clockRunning = true;
                gameData.clockInterval = setInterval(() => {
                    if (gameData.gameClock > 0) {
                        gameData.gameClock--;
                    }
                    updateClockDisplay();
                }, 1000);
            }
        }
        
        function pauseClock() {
            gameData.clockRunning = false;
            if (gameData.clockInterval) {
                clearInterval(gameData.clockInterval);
            }
        }
        
        function resetClock() {
            pauseClock();
            gameData.gameClock = gameData.currentPeriod <= 3 ? 1200 : 300;
            updateClockDisplay();
        }
        
        function updateClockDisplay() {
            const minutes = Math.floor(gameData.gameClock / 60);
            const seconds = gameData.gameClock % 60;
            document.getElementById('gameClock').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function openClockEditor(event) {
            event.preventDefault();
            const editor = document.getElementById('clockEditor');
            const minutes = Math.floor(gameData.gameClock / 60);
            const seconds = gameData.gameClock % 60;
            
            document.getElementById('clockMinutes').value = minutes;
            document.getElementById('clockSeconds').value = seconds;
            
            editor.style.left = event.pageX + 'px';
            editor.style.top = event.pageY + 'px';
            editor.classList.add('active');
            
            // Close editor when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeClockEditorOnClickOutside);
            }, 100);
        }
        
        function closeClockEditorOnClickOutside(event) {
            const editor = document.getElementById('clockEditor');
            if (!editor.contains(event.target) && event.target.id !== 'gameClock') {
                closeClockEditor();
            }
        }
        
        function closeClockEditor() {
            document.getElementById('clockEditor').classList.remove('active');
            document.removeEventListener('click', closeClockEditorOnClickOutside);
        }
        
        function setClockManual() {
            const minutes = parseInt(document.getElementById('clockMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('clockSeconds').value) || 0;
            
            gameData.gameClock = minutes * 60 + seconds;
            updateClockDisplay();
            closeClockEditor();
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }
        
        function logGoal(team) {
            let playerNum = null;
            let playerName = '';
            
            if (team === 'us') {
                const onIcePlayers = gameData.lines.flatMap(l => 
                    l.players.filter(p => p.onIce).map(p => ({ number: p.number, name: p.name }))
                );
                
                playerNum = prompt('Goal scored by jersey # (or press Enter to skip):');
                
                // Allow blank entry - just log the goal without player
                if (playerNum !== null && playerNum.trim() !== '') {
                    playerNum = playerNum.trim();
                    const player = onIcePlayers.find(p => p.number == playerNum);
                    playerName = player ? player.name : '';
                } else if (playerNum === null) {
                    // User cancelled
                    return;
                }
                // If empty string, just continue with null player
            }
            
            gameData.events.push({
                type: 'goal',
                team: team,
                playerNumber: playerNum,
                playerName: playerName,
                period: gameData.currentPeriod,
                strength: gameData.currentStrength,
                time: Date.now(),
                gameClock: gameData.gameClock
            });
            
            updateEventsList();
        }
        
        function logShot(team) {
            let playerNum = null;
            let playerName = '';
            
            if (team === 'us') {
                const onIcePlayers = gameData.lines.flatMap(l => 
                    l.players.filter(p => p.onIce).map(p => ({ number: p.number, name: p.name }))
                );
                
                playerNum = prompt('Shot by jersey # (or press Enter to skip):');
                
                // Allow blank entry - just log the shot without player
                if (playerNum !== null && playerNum.trim() !== '') {
                    playerNum = playerNum.trim();
                    const player = onIcePlayers.find(p => p.number == playerNum);
                    playerName = player ? player.name : '';
                } else if (playerNum === null) {
                    // User cancelled
                    return;
                }
                // If empty string, just continue with null player
            }
            
            gameData.events.push({
                type: 'shot',
                team: team,
                playerNumber: playerNum,
                playerName: playerName,
                period: gameData.currentPeriod,
                strength: gameData.currentStrength,
                time: Date.now(),
                gameClock: gameData.gameClock
            });
            
            updateEventsList();
        }
        
        function updateEventsList() {
            const list = document.getElementById('eventsList');
            const recent = gameData.events.slice(-5).reverse();
            
            if (recent.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--bench-gray); padding: 10px; font-size: 0.8rem;">No events logged</div>';
                return;
            }
            
            list.innerHTML = recent.map(e => {
                const clockMin = Math.floor(e.gameClock / 60);
                const clockSec = e.gameClock % 60;
                const clock = `${clockMin}:${String(clockSec).padStart(2, '0')}`;
                const teamLabel = e.team === 'us' ? 'NBC' : 'OPP';
                
                // Build player info - handle both null and empty cases
                let playerInfo = '';
                if (e.playerNumber && e.playerNumber.toString().trim() !== '') {
                    playerInfo = e.playerName 
                        ? `: #${e.playerNumber} ${e.playerName}` 
                        : `: #${e.playerNumber}`;
                }
                
                const oppClass = e.team === 'them' ? 'opponent' : '';
                
                return `
                    <div class="event-item ${e.type} ${oppClass}">
                        <span>${teamLabel} ${e.type.toUpperCase()}${playerInfo}</span>
                        <span>P${e.period} ${clock}</span>
                    </div>
                `;
            }).join('');
        }
        
        function updateSidebar() {
            const totalShifts = gameData.shifts.length;
            document.getElementById('totalShifts').textContent = totalShifts;
            
            const avgShift = totalShifts > 0 
                ? gameData.shifts.reduce((sum, s) => sum + s.length, 0) / totalShifts / 1000
                : 0;
            document.getElementById('avgShift').textContent = formatTime(avgShift);
            
            const longShifts = gameData.shifts.filter(s => s.length > 60000).length;
            document.getElementById('longShifts').textContent = longShifts;
            
            const ourGoals = gameData.events.filter(e => e.type === 'goal' && e.team === 'us').length;
            const theirGoals = gameData.events.filter(e => e.type === 'goal' && e.team === 'them').length;
            const ourShots = gameData.events.filter(e => e.type === 'shot' && e.team === 'us').length;
            const theirShots = gameData.events.filter(e => e.type === 'shot' && e.team === 'them').length;
            
            document.getElementById('ourGoals').textContent = ourGoals;
            document.getElementById('theirGoals').textContent = theirGoals;
            document.getElementById('ourShots').textContent = ourShots;
            document.getElementById('theirShots').textContent = theirShots;
            
            // Update header score display
            document.getElementById('scoreUs').textContent = ourGoals;
            document.getElementById('scoreThem').textContent = theirGoals;
            
            // Update faceoff stats
            const totalFO = gameData.faceoffs.length;
            const foWins = gameData.faceoffs.filter(f => f.result === 'W').length;
            const foPct = totalFO > 0 ? ((foWins / totalFO) * 100).toFixed(1) : '0.0';
            
            const oZoneFO = gameData.faceoffs.filter(f => f.zone === 'O');
            const oZoneWins = oZoneFO.filter(f => f.result === 'W').length;
            
            const nZoneFO = gameData.faceoffs.filter(f => f.zone === 'N');
            const nZoneWins = nZoneFO.filter(f => f.result === 'W').length;
            
            const dZoneFO = gameData.faceoffs.filter(f => f.zone === 'D');
            const dZoneWins = dZoneFO.filter(f => f.result === 'W').length;
            
            const cleanWins = gameData.faceoffs.filter(f => f.result === 'W' && f.clean === true).length;
            
            document.getElementById('totalFaceoffs').textContent = totalFO;
            document.getElementById('faceoffPct').textContent = foPct + '%';
            document.getElementById('oZoneFO').textContent = `${oZoneWins}-${oZoneFO.length - oZoneWins}`;
            document.getElementById('nZoneFO').textContent = `${nZoneWins}-${nZoneFO.length - nZoneWins}`;
            document.getElementById('dZoneFO').textContent = `${dZoneWins}-${dZoneFO.length - dZoneWins}`;
            document.getElementById('cleanWins').textContent = cleanWins;
        }
        
        function openLineEditor() {
            const modal = document.getElementById('lineEditorModal');
            const content = document.getElementById('lineEditorContent');
            
            content.innerHTML = gameData.lines.map((line, lineIdx) => `
                <div class="editor-section">
                    <div class="editor-section-title">${line.name}</div>
                    ${line.players.map((player, playerIdx) => `
                        <div class="player-editor">
                            <input type="number" value="${player.number}" 
                                   onchange="updatePlayer(${lineIdx}, ${playerIdx}, 'number', this.value)">
                            <input type="text" value="${player.name}" 
                                   onchange="updatePlayer(${lineIdx}, ${playerIdx}, 'name', this.value)">
                            <span style="color: var(--bench-gray);">${player.position}</span>
                        </div>
                    `).join('')}
                </div>
            `).join('');
            
            modal.classList.add('active');
        }
        
        function updatePlayer(lineIdx, playerIdx, field, value) {
            if (field === 'number') {
                gameData.lines[lineIdx].players[playerIdx][field] = parseInt(value);
            } else {
                gameData.lines[lineIdx].players[playerIdx][field] = value;
            }
        }
        
        function saveLineConfig() {
            // Strip out tracking state before saving config
            const configToSave = {
                lines: gameData.lines.map(line => ({
                    ...line,
                    onIce: false,
                    shiftStart: null,
                    players: line.players.map(player => ({
                        number: player.number,
                        name: player.name,
                        position: player.position,
                        onIce: false,
                        shiftStart: null
                    }))
                })),
                gameInfo: gameData.gameInfo
            };
            
            localStorage.setItem('hockeyTrackerConfig', JSON.stringify(configToSave));
            
            const blob = new Blob([JSON.stringify(configToSave, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hockey-tracker-config.json';
            a.click();
            
            alert('Configuration saved to browser and downloaded as file!');
        }
        
        function loadLineConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const config = JSON.parse(event.target.result);
                        
                        // Ensure player tracking state is properly initialized
                        if (config.lines) {
                            gameData.lines = config.lines.map(line => ({
                                ...line,
                                onIce: false,
                                shiftStart: null,
                                players: line.players.map(player => ({
                                    ...player,
                                    onIce: false,
                                    shiftStart: null
                                }))
                            }));
                        }
                        
                        gameData.gameInfo = config.gameInfo || gameData.gameInfo;
                        localStorage.setItem('hockeyTrackerConfig', JSON.stringify(config));
                        renderLines();
                        alert('Configuration loaded successfully!');
                        closeModal('lineEditorModal');
                    } catch (err) {
                        alert('Error loading configuration: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function openConfigModal() {
            const modal = document.getElementById('configModal');
            document.getElementById('gameDate').value = gameData.gameInfo.date;
            document.getElementById('opponent').value = gameData.gameInfo.opponent;
            document.getElementById('location').value = gameData.gameInfo.location;
            modal.classList.add('active');
        }
        
        function saveGameInfo() {
            gameData.gameInfo.date = document.getElementById('gameDate').value;
            gameData.gameInfo.opponent = document.getElementById('opponent').value;
            gameData.gameInfo.location = document.getElementById('location').value;
            alert('Game info saved!');
        }
        
        function importVideoTimestamps() {
            const text = document.getElementById('videoTimestamps').value;
            const lines = text.split('\n').filter(l => l.trim());
            
            gameData.videoTimestamps = lines.map(line => {
                const parts = line.trim().split(':').map(p => parseInt(p));
                if (parts.length === 2) {
                    return parts[0] * 60 + parts[1]; // MM:SS
                } else if (parts.length === 3) {
                    return parts[0] * 3600 + parts[1] * 60 + parts[2]; // HH:MM:SS
                }
                return 0;
            });
            
            alert(`Imported ${gameData.videoTimestamps.length} video timestamps!`);
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function exportCSV() {
            let csv = `Game Info\nDate,${gameData.gameInfo.date}\nOpponent,${gameData.gameInfo.opponent}\nLocation,${gameData.gameInfo.location}\n\n`;
            csv += 'Player,Name,Line,Period,Strength,Shift Start,Shift End,Length (sec),Game Clock,Video TS\n';
            
            gameData.shifts.forEach((shift, idx) => {
                const startTime = new Date(shift.startTime).toLocaleTimeString();
                const endTime = new Date(shift.endTime).toLocaleTimeString();
                const lengthSec = (shift.length / 1000).toFixed(1);
                const clockMin = Math.floor(shift.gameClock / 60);
                const clockSec = shift.gameClock % 60;
                const clock = `${clockMin}:${String(clockSec).padStart(2, '0')}`;
                const videoTS = gameData.videoTimestamps[idx] ? formatTime(gameData.videoTimestamps[idx]) : '';
                
                csv += `#${shift.playerNumber},${shift.playerName},${shift.lineName},P${shift.period},${shift.strength},${startTime},${endTime},${lengthSec},${clock},${videoTS}\n`;
            });
            
            csv += '\n\nPlayer Summary\n';
            csv += 'Player,Name,Total Shifts,Total TOI (min),Avg Shift (sec),5v5 TOI,PP TOI,PK TOI\n';
            
            const allPlayers = gameData.lines.flatMap(l => l.players);
            const uniquePlayers = [...new Map(allPlayers.map(p => [p.number, p])).values()];
            
            uniquePlayers.forEach(player => {
                const playerShifts = gameData.shifts.filter(s => s.playerNumber === player.number);
                if (playerShifts.length === 0) return;
                const totalTOI = playerShifts.reduce((sum, s) => sum + s.length, 0);
                const avgShift = totalTOI / playerShifts.length / 1000;
                
                const toi5v5 = playerShifts.filter(s => s.strength === '5v5').reduce((sum, s) => sum + s.length, 0);
                const toiPP = playerShifts.filter(s => s.strength === 'PP').reduce((sum, s) => sum + s.length, 0);
                const toiPK = playerShifts.filter(s => s.strength === 'PK').reduce((sum, s) => sum + s.length, 0);
                
                csv += `#${player.number},${player.name},${playerShifts.length},${(totalTOI / 60000).toFixed(2)},${avgShift.toFixed(1)},${(toi5v5 / 60000).toFixed(2)},${(toiPP / 60000).toFixed(2)},${(toiPK / 60000).toFixed(2)}\n`;
            });
            
            csv += '\n\nFaceoffs\n';
            csv += 'Player,Name,Zone,Result,Clean/Help,Period,Strength,Time,Game Clock\n';
            gameData.faceoffs.forEach(fo => {
                const clockMin = Math.floor(fo.gameClock / 60);
                const clockSec = fo.gameClock % 60;
                const clock = `${clockMin}:${String(clockSec).padStart(2, '0')}`;
                const time = new Date(fo.time).toLocaleTimeString();
                const zoneName = fo.zone === 'O' ? 'Offensive' : fo.zone === 'N' ? 'Neutral' : 'Defensive';
                const cleanHelp = fo.result === 'W' ? (fo.clean ? 'Clean' : 'Help') : '-';
                csv += `#${fo.playerNumber},${fo.playerName},${zoneName},${fo.result === 'W' ? 'Win' : 'Loss'},${cleanHelp},P${fo.period},${fo.strength},${time},${clock}\n`;
            });
            
            csv += '\n\nFaceoff Summary by Player\n';
            csv += 'Player,Name,Total FO,Wins,Losses,Win %,O-Zone,N-Zone,D-Zone,Clean Wins\n';
            uniquePlayers.forEach(player => {
                const playerFO = gameData.faceoffs.filter(f => f.playerNumber === player.number);
                if (playerFO.length === 0) return;
                
                const wins = playerFO.filter(f => f.result === 'W').length;
                const losses = playerFO.length - wins;
                const winPct = ((wins / playerFO.length) * 100).toFixed(1);
                const oZone = `${playerFO.filter(f => f.zone === 'O' && f.result === 'W').length}-${playerFO.filter(f => f.zone === 'O' && f.result === 'L').length}`;
                const nZone = `${playerFO.filter(f => f.zone === 'N' && f.result === 'W').length}-${playerFO.filter(f => f.zone === 'N' && f.result === 'L').length}`;
                const dZone = `${playerFO.filter(f => f.zone === 'D' && f.result === 'W').length}-${playerFO.filter(f => f.zone === 'D' && f.result === 'L').length}`;
                const clean = playerFO.filter(f => f.result === 'W' && f.clean === true).length;
                
                csv += `#${player.number},${player.name},${playerFO.length},${wins},${losses},${winPct}%,${oZone},${nZone},${dZone},${clean}\n`;
            });
            
            csv += '\n\nEvents\n';
            csv += 'Team,Type,Player,Period,Strength,Time,Game Clock\n';
            gameData.events.forEach(event => {
                const clockMin = Math.floor(event.gameClock / 60);
                const clockSec = event.gameClock % 60;
                const clock = `${clockMin}:${String(clockSec).padStart(2, '0')}`;
                const time = new Date(event.time).toLocaleTimeString();
                const team = event.team === 'us' ? 'NBC' : 'OPP';
                const player = (event.playerNumber && event.playerNumber.toString().trim()) 
                    ? (event.playerName ? `#${event.playerNumber} ${event.playerName}` : `#${event.playerNumber}`)
                    : '';
                csv += `${team},${event.type},${player},P${event.period},${event.strength},${time},${clock}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shift-tracker-${gameData.gameInfo.date || new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }
        
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.text('Hockey Shift Tracker Report', 105, 15, { align: 'center' });
            
            // Score
            const ourGoals = gameData.events.filter(e => e.type === 'goal' && e.team === 'us').length;
            const theirGoals = gameData.events.filter(e => e.type === 'goal' && e.team === 'them').length;
            doc.setFontSize(16);
            doc.text(`Final Score: Newburyport ${ourGoals} - ${theirGoals} ${gameData.gameInfo.opponent || 'Opponent'}`, 105, 22, { align: 'center' });
            
            // Game Info
            doc.setFontSize(12);
            doc.text(`Date: ${gameData.gameInfo.date || 'N/A'}`, 20, 35);
            doc.text(`Opponent: ${gameData.gameInfo.opponent || 'N/A'}`, 20, 42);
            doc.text(`Location: ${gameData.gameInfo.location || 'N/A'}`, 20, 49);
            
            let yPosition = 60;
            
            // Period-by-Period TOI Reports (Catapult Style)
            for (let period = 1; period <= 4; period++) {
                const periodShifts = gameData.shifts.filter(s => s.period === period);
                if (periodShifts.length === 0) continue;
                
                // Check if we need a new page
                if (yPosition > 240) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(14);
                doc.text(`Period ${period}`, 20, yPosition);
                yPosition += 5;
                
                // Calculate per-player stats for this period
                const allPlayers = gameData.lines.flatMap(l => l.players);
                const uniquePlayers = [...new Map(allPlayers.map(p => [p.number, p])).values()];
                
                const periodData = uniquePlayers.map(player => {
                    const playerShifts = periodShifts.filter(s => s.playerNumber === player.number);
                    
                    if (playerShifts.length === 0) {
                        return [
                            `${player.number}`,
                            player.name,
                            0,
                            '00:00',
                            '00:00',
                            '00:00',
                            '00:00',
                            '00:00'
                        ];
                    }
                    
                    const totalTOI = playerShifts.reduce((sum, s) => sum + s.length, 0);
                    const toi5v5 = playerShifts.filter(s => s.strength === '5v5').reduce((sum, s) => sum + s.length, 0);
                    const toiPP = playerShifts.filter(s => s.strength === 'PP').reduce((sum, s) => sum + s.length, 0);
                    const toiPK = playerShifts.filter(s => s.strength === 'PK').reduce((sum, s) => sum + s.length, 0);
                    const avgEven = playerShifts.filter(s => s.strength === '5v5').length > 0
                        ? toi5v5 / playerShifts.filter(s => s.strength === '5v5').length
                        : 0;
                    
                    return [
                        `${player.number}`,
                        player.name,
                        playerShifts.length,
                        formatTime(totalTOI / 1000),
                        formatTime(toi5v5 / 1000),
                        formatTime(toiPP / 1000),
                        formatTime(toiPK / 1000),
                        formatTime(avgEven / 1000)
                    ];
                }).filter(row => row[2] > 0); // Only include players who played
                
                doc.autoTable({
                    startY: yPosition,
                    head: [['#', 'Player', 'Shifts', 'Total', 'Even', 'PP', 'PK', 'Even Avg']],
                    body: periodData,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [0, 102, 204] }
                });
                
                yPosition = doc.lastAutoTable.finalY + 15;
            }
            
            // New page for game totals
            doc.addPage();
            doc.setFontSize(16);
            doc.text('Game Totals', 20, 20);
            
            // Calculate game totals
            const allPlayers = gameData.lines.flatMap(l => l.players);
            const uniquePlayers = [...new Map(allPlayers.map(p => [p.number, p])).values()];
            
            const gameTotalData = uniquePlayers.map(player => {
                const playerShifts = gameData.shifts.filter(s => s.playerNumber === player.number);
                
                if (playerShifts.length === 0) {
                    return null;
                }
                
                const totalTOI = playerShifts.reduce((sum, s) => sum + s.length, 0);
                const toi5v5 = playerShifts.filter(s => s.strength === '5v5').reduce((sum, s) => sum + s.length, 0);
                const toiPP = playerShifts.filter(s => s.strength === 'PP').reduce((sum, s) => sum + s.length, 0);
                const toiPK = playerShifts.filter(s => s.strength === 'PK').reduce((sum, s) => sum + s.length, 0);
                const avgEven = playerShifts.filter(s => s.strength === '5v5').length > 0
                    ? toi5v5 / playerShifts.filter(s => s.strength === '5v5').length
                    : 0;
                
                return [
                    `${player.number}`,
                    player.name,
                    playerShifts.length,
                    formatTime(totalTOI / 1000),
                    formatTime(toi5v5 / 1000),
                    formatTime(toiPP / 1000),
                    formatTime(toiPK / 1000),
                    formatTime(avgEven / 1000)
                ];
            }).filter(row => row !== null);
            
            doc.autoTable({
                startY: 30,
                head: [['#', 'Player', 'Shifts', 'Total', 'Even', 'PP', 'PK', 'Even Avg']],
                body: gameTotalData,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [0, 102, 204] }
            });
            
            // Event Summary by Player
            if (gameData.events.length > 0) {
                doc.addPage();
                doc.setFontSize(16);
                doc.text('Event Summary', 20, 20);
                
                // Calculate event totals per player
                const playerEventData = uniquePlayers.map(player => {
                    const goals = gameData.events.filter(e => 
                        e.type === 'goal' && e.team === 'us' && 
                        e.playerNumber && e.playerNumber.toString().trim() !== '' &&
                        e.playerNumber == player.number
                    ).length;
                    const shots = gameData.events.filter(e => 
                        e.type === 'shot' && e.team === 'us' && 
                        e.playerNumber && e.playerNumber.toString().trim() !== '' &&
                        e.playerNumber == player.number
                    ).length;
                    
                    if (goals === 0 && shots === 0) return null;
                    
                    return [
                        `${player.number}`,
                        player.name,
                        goals,
                        shots,
                        shots > 0 ? ((goals / shots) * 100).toFixed(1) + '%' : '-'
                    ];
                }).filter(row => row !== null);
                
                if (playerEventData.length > 0) {
                    doc.autoTable({
                        startY: 30,
                        head: [['#', 'Player', 'Goals', 'Shots', 'Shooting %']],
                        body: playerEventData,
                        theme: 'grid',
                        styles: { fontSize: 10 },
                        headStyles: { fillColor: [0, 230, 118] }
                    });
                }
                
                // Goal Timeline
                const goals = gameData.events.filter(e => e.type === 'goal');
                if (goals.length > 0) {
                    const yPos = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : 80;
                    doc.setFontSize(14);
                    doc.text('Goal Timeline', 20, yPos);
                    
                    const goalData = goals.map(e => {
                        const clockMin = Math.floor(e.gameClock / 60);
                        const clockSec = e.gameClock % 60;
                        const clock = `${clockMin}:${String(clockSec).padStart(2, '0')}`;
                        const team = e.team === 'us' ? 'NBC' : gameData.gameInfo.opponent || 'OPP';
                        
                        let player = 'Unknown';
                        if (e.playerNumber && e.playerNumber.toString().trim() !== '') {
                            player = e.playerName ? `#${e.playerNumber} ${e.playerName}` : `#${e.playerNumber}`;
                        }
                        
                        return [
                            `P${e.period}`,
                            clock,
                            team,
                            player,
                            e.strength
                        ];
                    });
                    
                    doc.autoTable({
                        startY: yPos + 5,
                        head: [['Period', 'Time', 'Team', 'Scorer', 'Strength']],
                        body: goalData,
                        theme: 'grid',
                        styles: { fontSize: 9 },
                        headStyles: { fillColor: [26, 35, 50] }
                    });
                    
                    // Team totals after goal timeline
                    const teamYPos = doc.lastAutoTable.finalY + 15;
                    doc.setFontSize(14);
                    doc.text('Team Totals', 20, teamYPos);
                    
                    const teamData = [
                        ['Newburyport', ourGoals, gameData.events.filter(e => e.type === 'shot' && e.team === 'us').length],
                        [gameData.gameInfo.opponent || 'Opponent', theirGoals, gameData.events.filter(e => e.type === 'shot' && e.team === 'them').length]
                    ];
                    
                    doc.autoTable({
                        startY: teamYPos + 5,
                        head: [['Team', 'Goals', 'Shots']],
                        body: teamData,
                        theme: 'grid',
                        styles: { fontSize: 11 },
                        headStyles: { fillColor: [26, 35, 50] }
                    });
                } else {
                    // Team totals if no goals
                    const yPos = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : 80;
                    doc.setFontSize(14);
                    doc.text('Team Totals', 20, yPos);
                    
                    const teamData = [
                        ['Newburyport', ourGoals, gameData.events.filter(e => e.type === 'shot' && e.team === 'us').length],
                        [gameData.gameInfo.opponent || 'Opponent', theirGoals, gameData.events.filter(e => e.type === 'shot' && e.team === 'them').length]
                    ];
                    
                    doc.autoTable({
                        startY: yPos + 5,
                        head: [['Team', 'Goals', 'Shots']],
                        body: teamData,
                        theme: 'grid',
                        styles: { fontSize: 11 },
                        headStyles: { fillColor: [26, 35, 50] }
                    });
                }
            }
            
            // Faceoff Summary
            if (gameData.faceoffs.length > 0) {
                doc.addPage();
                doc.setFontSize(16);
                doc.text('Faceoff Report', 20, 20);
                
                // Group players by line for faceoff report
                const lineGroups = [];
                gameData.lines.forEach(line => {
                    const lineData = {
                        lineName: line.name,
                        players: []
                    };
                    
                    line.players.forEach(player => {
                        const playerFO = gameData.faceoffs.filter(f => f.playerNumber === player.number);
                        if (playerFO.length > 0) {
                            // Calculate zone √ó strength matrix
                            const calc = (zone, strength) => {
                                const filtered = playerFO.filter(f => f.zone === zone && f.strength === strength);
                                const wins = filtered.filter(f => f.result === 'W').length;
                                const total = filtered.length;
                                const pct = total > 0 ? ((wins / total) * 100).toFixed(0) : '0';
                                return total > 0 ? `${wins}-${total - wins} ${pct}%` : '-';
                            };
                            
                            const calcZone = (zone) => {
                                const filtered = playerFO.filter(f => f.zone === zone);
                                const wins = filtered.filter(f => f.result === 'W').length;
                                const total = filtered.length;
                                const pct = total > 0 ? ((wins / total) * 100).toFixed(0) : '0';
                                return total > 0 ? `${wins}-${total - wins} ${pct}%` : '-';
                            };
                            
                            const calcStrength = (strength) => {
                                const filtered = playerFO.filter(f => f.strength === strength);
                                const wins = filtered.filter(f => f.result === 'W').length;
                                const total = filtered.length;
                                const pct = total > 0 ? ((wins / total) * 100).toFixed(0) : '0';
                                return total > 0 ? `${wins}-${total - wins} ${pct}%` : '-';
                            };
                            
                            const totalWins = playerFO.filter(f => f.result === 'W').length;
                            const totalFO = playerFO.length;
                            const totalPct = ((totalWins / totalFO) * 100).toFixed(0);
                            
                            lineData.players.push({
                                name: `${player.number} ${player.name}`,
                                oZone: calcZone('O'),
                                nZone: calcZone('N'),
                                dZone: calcZone('D'),
                                even: calcStrength('5v5'),
                                pp: calcStrength('PP'),
                                pk: calcStrength('PK'),
                                total: `${totalWins}-${totalFO - totalWins} ${totalPct}%`
                            });
                        }
                    });
                    
                    if (lineData.players.length > 0) {
                        lineGroups.push(lineData);
                    }
                });
                
                // Build table with line grouping
                let yPos = 30;
                lineGroups.forEach((lineGroup, idx) => {
                    // Check if we need a new page
                    if (yPos > 240) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Line header
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text(lineGroup.lineName, 20, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 5;
                    
                    // Player data for this line
                    const tableData = lineGroup.players.map(p => [
                        p.name,
                        p.oZone,
                        p.nZone,
                        p.dZone,
                        p.even,
                        p.pp,
                        p.pk,
                        p.total
                    ]);
                    
                    doc.autoTable({
                        startY: yPos,
                        head: idx === 0 ? [['Player', 'OZ', 'NZ', 'DZ', 'EVEN', 'PP', 'PK', 'TOTAL']] : [],
                        body: tableData,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 2 },
                        headStyles: { fillColor: [0, 102, 204], fontSize: 8 },
                        columnStyles: {
                            0: { cellWidth: 35 },
                            1: { cellWidth: 20 },
                            2: { cellWidth: 20 },
                            3: { cellWidth: 20 },
                            4: { cellWidth: 20 },
                            5: { cellWidth: 20 },
                            6: { cellWidth: 20 },
                            7: { cellWidth: 25 }
                        }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 10;
                });
                
                // Team totals at bottom
                if (yPos > 220) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('TEAM TOTALS', 20, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 5;
                
                // Calculate team totals
                const calcTeamZone = (zone) => {
                    const filtered = gameData.faceoffs.filter(f => f.zone === zone);
                    const wins = filtered.filter(f => f.result === 'W').length;
                    const total = filtered.length;
                    const pct = total > 0 ? ((wins / total) * 100).toFixed(0) : '0';
                    return total > 0 ? `${wins}-${total - wins} ${pct}%` : '0-0 0%';
                };
                
                const calcTeamStrength = (strength) => {
                    const filtered = gameData.faceoffs.filter(f => f.strength === strength);
                    const wins = filtered.filter(f => f.result === 'W').length;
                    const total = filtered.length;
                    const pct = total > 0 ? ((wins / total) * 100).toFixed(0) : '0';
                    return total > 0 ? `${wins}-${total - wins} ${pct}%` : '0-0 0%';
                };
                
                const totalWins = gameData.faceoffs.filter(f => f.result === 'W').length;
                const totalFO = gameData.faceoffs.length;
                const totalPct = totalFO > 0 ? ((totalWins / totalFO) * 100).toFixed(0) : '0';
                
                const teamTotals = [[
                    'ALL',
                    calcTeamZone('O'),
                    calcTeamZone('N'),
                    calcTeamZone('D'),
                    calcTeamStrength('5v5'),
                    calcTeamStrength('PP'),
                    calcTeamStrength('PK'),
                    `${totalWins}-${totalFO - totalWins} ${totalPct}%`
                ]];
                
                doc.autoTable({
                    startY: yPos,
                    body: teamTotals,
                    theme: 'grid',
                    styles: { fontSize: 9, cellPadding: 2, fontStyle: 'bold' },
                    columnStyles: {
                        0: { cellWidth: 35, fillColor: [220, 220, 220] },
                        1: { cellWidth: 20 },
                        2: { cellWidth: 20 },
                        3: { cellWidth: 20 },
                        4: { cellWidth: 20 },
                        5: { cellWidth: 20 },
                        6: { cellWidth: 20 },
                        7: { cellWidth: 25 }
                    }
                });
            }
            
            doc.save(`shift-tracker-${gameData.gameInfo.date || new Date().toISOString().slice(0,10)}.pdf`);
        }
        
        function clearData() {
            if (!confirm('Clear all shift and event data? Line configuration will be preserved.')) return;
            
            gameData.shifts = [];
            gameData.events = [];
            gameData.faceoffs = [];
            gameData.lines.forEach(line => {
                line.onIce = false;
                line.shiftStart = null;
                line.players.forEach(player => {
                    player.onIce = false;
                    player.shiftStart = null;
                });
            });
            gameData.videoTimestamps = [];
            
            pauseClock();
            resetClock();
            renderLines();
            updateEventsList();
        }
        
        // Initialize
        renderLines();
        updateClockDisplay();
        updateEventsList();
        setInterval(updateSidebar, 100);

// ==================== EXPOSE FUNCTIONS GLOBALLY ====================
// Make ALL functions available to inline onclick handlers
window.showLogin = showLogin;
window.showSignup = showSignup;
window.handleLogin = handleLogin;
window.handleSignup = handleSignup;
window.handleLogout = handleLogout;
window.startNewGame = startNewGame;
window.confirmLeaveGame = confirmLeaveGame;
window.saveGameNow = saveGameNow;
window.showGameLibrary = showGameLibrary;
window.loadGame = loadGame;
window.deleteGame = deleteGame;
window.showScreen = showScreen;
window.setPeriod = setPeriod;
window.setStrength = setStrength;
window.startClock = startClock;
window.pauseClock = pauseClock;
window.resetClock = resetClock;
window.setClockManual = setClockManual;
window.closeClockEditor = closeClockEditor;
window.logGoal = logGoal;
window.logShot = logShot;
window.openFaceoffModal = openFaceoffModal;
window.setFaceoffZone = setFaceoffZone;
window.setFaceoffResult = setFaceoffResult;
window.setFaceoffClean = setFaceoffClean;
window.saveFaceoff = saveFaceoff;
window.openLineEditor = openLineEditor;
window.saveLineConfig = saveLineConfig;
window.loadLineConfig = loadLineConfig;
window.openConfigModal = openConfigModal;
window.saveGameInfo = saveGameInfo;
window.importVideoTimestamps = importVideoTimestamps;
window.closeModal = closeModal;
window.exportCSV = exportCSV;
window.exportPDF = exportPDF;
window.clearData = clearData;
window.toggleLine = toggleLine;
window.togglePlayer = togglePlayer;
</script>
</body>
</html>
